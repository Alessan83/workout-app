<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Workout 100</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#111;color:#eee;padding:15px;text-align:center}
  button{padding:8px 10px;margin:6px;background:#222;color:#eee;border:1px solid #444;border-radius:6px}
  button:active{transform:translateY(1px)}
  select,input[type="checkbox"]{background:#222;color:#eee;border:1px solid #444;padding:5px;border-radius:6px}
  .section{margin:18px 0;font-weight:bold;font-size:16px;display:flex;justify-content:center;align-items:center;gap:8px}
  .exercise{border:1px solid #333;padding:10px;margin:8px 0;text-align:left;border-radius:10px;background:#141414}
  a{color:#4da6ff;text-decoration:none}
  a:hover{text-decoration:underline}
  .small{font-size:12px;color:#aaa}
  .pill{display:inline-block;border:1px solid #333;padding:4px 8px;margin:4px;background:#151515;border-radius:999px}
  .square{width:14px;height:14px;border:1px solid #444;display:inline-block;margin-right:6px;vertical-align:middle;border-radius:3px}
  .done{background:#2a7a2a}
  hr{border:0;border-top:1px solid #333;margin:14px 0}
  .row{display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap}
  .miniCard{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid #333;background:#151515;border-radius:12px}
  .badge{display:inline-block;font-size:11px;color:#bbb;border:1px solid #2f2f2f;padding:2px 6px;border-radius:999px;background:#101010}
  .topLine{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
  .icons{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .svgIcon{width:18px;height:18px;opacity:.9}
  .sketch{width:38px;height:38px;border:1px solid #2f2f2f;border-radius:10px;background:#101010;display:flex;align-items:center;justify-content:center;flex:0 0 auto}
  .sketch svg{width:30px;height:30px}
  .exBody{display:flex;gap:10px;align-items:flex-start}
  .exText{flex:1}
  .linkRow{display:flex;gap:12px;flex-wrap:wrap;margin-top:6px}
</style>
</head>
<body>

<h2>Workout 100</h2>

<div class="row">
  <span class="miniCard">
    <label class="small" style="margin-right:6px">Durata</label>
    <select id="mode" onchange="generateWorkout()">
      <option value="25">25 minuti</option>
      <option value="35">35 minuti</option>
    </select>
  </span>

  <span class="miniCard">
    <label class="small" style="margin-right:6px">Giorno corsa</label>
    <input type="checkbox" id="runDay" onchange="generateWorkout()">
  </span>

  <span class="miniCard">
    <label class="small" style="margin-right:6px">RPE sessione</label>
    <select id="sessionRPE">
      <option value="1">Facile</option>
      <option value="2" selected>Medio</option>
      <option value="3">Duro</option>
    </select>
  </span>
</div>

<div class="row" style="margin-top:8px">
  <span id="doneSquare" class="square"></span>
  <span class="pill">Streak: <span id="streak">0</span></span>
  <span class="pill">Allenamenti totali: <span id="totalW">0</span></span>
  <span class="pill">Settimana ciclo: <span id="cycleW">1</span>/4</span>
</div>

<hr>

<div id="program"></div>

<hr>

<div class="row">
  <span class="pill">Fase: <b id="phase">â€”</b></span>
  <span class="pill">Tempo: <b id="timeLeft">â€”</b></span>
</div>

<div class="row" style="margin-top:10px">
  <button onclick="startSession()">Start</button>
  <button onclick="nextPhase()">Next</button>
  <button onclick="completeWorkout()">Allenamento completato</button>
</div>

<div class="row" style="margin-top:10px">
  <button onclick="exportLog()">Esporta log (JSON)</button>
  <button onclick="copyTodayToClipboard()">Copia sessione di oggi</button>
</div>

<script>
/* ===========================
   STORAGE
=========================== */
const STORE="workoutV9";
let data = JSON.parse(localStorage.getItem(STORE)) || {
  completedDate:null,
  streak:0,
  totalWorkouts:0,
  bandIndex:0,   // 0=15,1=25,2=35
  baseReps:12,
  logs:[]
};
function save(){ localStorage.setItem(STORE, JSON.stringify(data)); }
function today(){ return new Date().toISOString().split("T")[0]; }

/* ===========================
   MINI ICONS
=========================== */
function iconSVG(kind){
  const stroke = "currentColor";
  if(kind==="warm") return `<svg class="svgIcon" viewBox="0 0 24 24" fill="none"><path d="M7 14c2 2 8 2 10 0" stroke="${stroke}" stroke-width="2"/><path d="M12 3v6" stroke="${stroke}" stroke-width="2"/><path d="M5 21c3-6 11-6 14 0" stroke="${stroke}" stroke-width="2"/></svg>`;
  if(kind==="mob") return `<svg class="svgIcon" viewBox="0 0 24 24" fill="none"><path d="M4 12h16" stroke="${stroke}" stroke-width="2"/><path d="M12 4v16" stroke="${stroke}" stroke-width="2"/><path d="M7 7l10 10" stroke="${stroke}" stroke-width="2"/></svg>`;
  if(kind==="train") return `<svg class="svgIcon" viewBox="0 0 24 24" fill="none"><path d="M4 14h6l2-4 2 8 2-4h4" stroke="${stroke}" stroke-width="2"/></svg>`;
  if(kind==="stretch") return `<svg class="svgIcon" viewBox="0 0 24 24" fill="none"><path d="M6 18c4-8 8-8 12 0" stroke="${stroke}" stroke-width="2"/><path d="M6 18h12" stroke="${stroke}" stroke-width="2"/></svg>`;
  return "";
}
function sketchSVG(type){
  const stroke="#cfcfcf";
  if(type==="push") return `<svg viewBox="0 0 64 64" fill="none">
    <circle cx="18" cy="20" r="6" stroke="${stroke}" stroke-width="3"/>
    <path d="M10 30h36" stroke="${stroke}" stroke-width="3"/>
    <path d="M18 26l-6 20" stroke="${stroke}" stroke-width="3"/>
    <path d="M24 26l8 18" stroke="${stroke}" stroke-width="3"/>
    <path d="M38 30l10 10" stroke="${stroke}" stroke-width="3"/>
  </svg>`;
  if(type==="pull") return `<svg viewBox="0 0 64 64" fill="none">
    <circle cx="24" cy="14" r="6" stroke="${stroke}" stroke-width="3"/>
    <path d="M24 20v14" stroke="${stroke}" stroke-width="3"/>
    <path d="M14 30h40" stroke="${stroke}" stroke-width="3"/>
    <path d="M24 34l-10 16" stroke="${stroke}" stroke-width="3"/>
    <path d="M24 34l10 16" stroke="${stroke}" stroke-width="3"/>
    <path d="M42 26c-2 6-6 8-12 8" stroke="${stroke}" stroke-width="3"/>
  </svg>`;
  if(type==="hinge") return `<svg viewBox="0 0 64 64" fill="none">
    <circle cx="22" cy="14" r="6" stroke="${stroke}" stroke-width="3"/>
    <path d="M22 20l10 12" stroke="${stroke}" stroke-width="3"/>
    <path d="M32 32l18 2" stroke="${stroke}" stroke-width="3"/>
    <path d="M30 32l-10 18" stroke="${stroke}" stroke-width="3"/>
    <path d="M36 34l-2 18" stroke="${stroke}" stroke-width="3"/>
  </svg>`;
  if(type==="core") return `<svg viewBox="0 0 64 64" fill="none">
    <circle cx="18" cy="18" r="6" stroke="${stroke}" stroke-width="3"/>
    <path d="M12 28h40" stroke="${stroke}" stroke-width="3"/>
    <path d="M20 24l-8 24" stroke="${stroke}" stroke-width="3"/>
    <path d="M28 24l8 24" stroke="${stroke}" stroke-width="3"/>
    <path d="M44 28l10 18" stroke="${stroke}" stroke-width="3"/>
  </svg>`;
  if(type==="mob") return `<svg viewBox="0 0 64 64" fill="none">
    <circle cx="32" cy="14" r="6" stroke="${stroke}" stroke-width="3"/>
    <path d="M32 20v24" stroke="${stroke}" stroke-width="3"/>
    <path d="M20 30c6-6 18-6 24 0" stroke="${stroke}" stroke-width="3"/>
    <path d="M22 52h20" stroke="${stroke}" stroke-width="3"/>
  </svg>`;
  return `<svg viewBox="0 0 64 64" fill="none"><path d="M12 32h40" stroke="${stroke}" stroke-width="3"/></svg>`;
}

/* ===========================
   DB ESERCIZI (con note e tipo interno)
=========================== */
const DB = {
  warm: [
    {n:"Jumping Jacks", note:"Atterra morbido. Core leggermente attivo.", type:"warm"},
    {n:"High Knees", note:"Busto stabile. Non collassare con le spalle.", type:"warm"},
    {n:"Shadow Boxing", note:"Scapole basse. Gomiti vicini.", type:"warm"},
    {n:"Inchworm", note:"Non iperestendere lombare. Addome attivo.", type:"warm"},
    {n:"Scapular Push-up", note:"Spingi via le scapole senza piegare i gomiti.", type:"warm"},
    {n:"Arm Circles", note:"Movimento controllato: evita compensi lombari.", type:"warm"},
    {n:"Squat to Stand (light)", note:"Apri anche e caviglie, niente dolore.", type:"warm"},
  ],
  mobility: [
    {n:"Thoracic Rotation (quadruped)", note:"Bacino fermo, ruota solo dorsale.", type:"mob"},
    {n:"Open Book", note:"Respira. Spalle giÃ¹, non forzare.", type:"mob"},
    {n:"Cat-Cow", note:"Segmenta la colonna, lento.", type:"mob"},
    {n:"Ankle Rock (knee to wall)", note:"Tallone giÃ¹, ginocchio segue la punta.", type:"mob"},
    {n:"Wall Slides", note:"Costole giÃ¹, non inarcare.", type:"mob"},
    {n:"Hip CARs", note:"Lento. Bacino stabile, range controllato.", type:"mob"},
  ],
  coreMobility: [
    {n:"Dead Bug (slow)", note:"Lombare a terra. Espira in estensione.", type:"core"},
    {n:"Bird Dog (slow)", note:"Bacino stabile. Allunga, non ruotare.", type:"core"},
    {n:"Pallof Press (band)", note:"Anti-rotazione. Costole giÃ¹.", type:"core"},
    {n:"Bear Hover (10â€“20s)", note:"Ginocchia 2 cm da terra. Collo neutro.", type:"core"},
    {n:"Side Plank Reach", note:"Spingi via la spalla. Bacino alto.", type:"core"},
  ],
  stretch: [
    {n:"Child Pose", note:"Respirazione lenta, allunga il dorso.", type:"stretch"},
    {n:"Hip Flexor Stretch", note:"Retroversione bacino, gluteo attivo.", type:"stretch"},
    {n:"Hamstring Stretch", note:"Schiena neutra, non rimbalzare.", type:"stretch"},
    {n:"Pec Stretch (doorway)", note:"Spalle basse. Non stressare spalla.", type:"stretch"},
    {n:"Calf Stretch", note:"Tallone giÃ¹, ginocchio in linea.", type:"stretch"},
  ],
  training: [
    {n:"Band Row", note:"Spalle basse. Gomiti vicino al corpo. Pausa 1s in chiusura.", t:"pull"},
    {n:"Band High Row", note:"Tira verso alto petto. Evita spalle alle orecchie.", t:"pull"},
    {n:"Band Face Pull", note:"Tira verso il viso. Scapole addotte e depresse.", t:"pull"},
    {n:"Band Pull-Apart", note:"Costole giÃ¹. Non iperestendere schiena.", t:"pull"},
    {n:"Band Reverse Fly", note:"Controllo. Polsi neutri, scapole stabili.", t:"pull"},

    {n:"Push-up", note:"Core attivo, bacino neutro. Mani sotto spalle.", t:"push"},
    {n:"Incline Push-up", note:"Allinea testa-bacino-caviglia. Controllo discesa.", t:"push"},
    {n:"Diamond Push-up", note:"Gomiti non troppo aperti. Core attivo.", t:"push"},
    {n:"Pike Push-up", note:"Spingi verticalmente. Collo neutro.", t:"push"},
    {n:"Band Overhead Press", note:"Costole giÃ¹. Non inarcare lombare.", t:"push"},
    {n:"Band Floor Press", note:"Spalle giÃ¹. Controllo in eccentrica.", t:"push"},
    {n:"Band Triceps Extension", note:"Gomiti fermi. Non compensare con schiena.", t:"push"},

    {n:"Banded RDL", note:"Hinge. Schiena neutra. Spingi glutei indietro.", t:"hinge"},
    {n:"Good Morning (band)", note:"Range corto. Colonna neutra, core attivo.", t:"hinge"},
    {n:"Glute Bridge (band)", note:"Retroversione. Spingi da talloni, pausa 1s.", t:"hinge"},
    {n:"Single-Leg RDL (light)", note:"Caviglia stabile. Bacino quadrato.", t:"hinge"},
    {n:"Monster Walk (miniloop)", note:"Ginocchia spinte fuori. Bacino stabile.", t:"hinge"},
    {n:"Tibialis Raise", note:"Controllo. Non dondolare.", t:"hinge"},
    {n:"Calf Raise (slow)", note:"Pausa in alto. Caviglia stabile.", t:"hinge"},

    {n:"Plank", note:"Costole giÃ¹. Glutei attivi. No cedimenti lombari.", t:"core"},
    {n:"Side Plank", note:"Bacino alto. Spalla stabile.", t:"core"},
    {n:"Pallof Press (band)", note:"Anti-rotazione. Respira.", t:"core"},
  ]
};

/* ===========================
   Random stabile + anti-ripetizione
=========================== */
function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296;}}
function seedFromDate(str){let n=0;for(let i=0;i<str.length;i++)n=(n*31+str.charCodeAt(i))>>>0;return n;}
function getHistoryKey(cat){ return "hist_"+cat; }

function pickStable(listKey, list, count){
  const rng = mulberry32(seedFromDate(today()+":"+listKey));
  const histKey = getHistoryKey(listKey);
  const hist = JSON.parse(localStorage.getItem(histKey) || "[]");

  let pool = list.filter(x => !hist.includes(x.n));
  if(pool.length < count) pool = list.slice();

  for(let i=pool.length-1;i>0;i--){
    const j = Math.floor(rng()*(i+1));
    [pool[i],pool[j]]=[pool[j],pool[i]];
  }

  const picked = pool.slice(0,count);
  const pickedNames = picked.map(x=>x.n);

  const newHist = [...pickedNames, ...hist].slice(0,12);
  localStorage.setItem(histKey, JSON.stringify(newHist));

  return picked;
}

/* ===========================
   Tutorial LINKS (richiesto)
=========================== */
function tutorialLinkYT(name){
  return "https://www.youtube.com/results?search_query="+encodeURIComponent(name+" exercise tutorial");
}
function tutorialLinkIMG(name){
  return "https://www.google.com/search?tbm=isch&q="+encodeURIComponent(name+" exercise");
}

/* ===========================
   Periodizzazione 4 settimane + Progressione RPE-based
=========================== */
const BAND_LEVELS = [15,25,35];

function weekInCycle(){
  const w = Math.floor((data.totalWorkouts % 16) / 4) + 1; // 1..4
  return w;
}

function calcSuggestion(){
  const mode = parseInt(document.getElementById("mode").value,10);
  const runDay = document.getElementById("runDay").checked;
  const w = weekInCycle();

  let trainingCount = (mode===25) ? 6 : 8;
  let cycles = (mode===25) ? 2 : 3;

  let reps = data.baseReps;

  if(w===2) reps = Math.min(20, reps + 2);
  if(w===3) reps = Math.min(20, reps + 4);
  if(w===4) reps = Math.max(8, reps - 4);

  let bandIdx = data.bandIndex;
  if(w===4) bandIdx = Math.max(0, bandIdx - 1);
  const band = BAND_LEVELS[bandIdx];

  if(runDay){
    reps = Math.max(8, reps - 2);
  }

  return {band, bandIdx, reps, trainingCount, cycles, weekInCycle:w, runDay, mode};
}

/* ===========================
   RENDER
=========================== */
function sectionHeader(title, kind){
  return `<div class="section">${iconSVG(kind)}<span>${title}</span></div>`;
}

function exerciseCard(obj, extraLine, sketchType){
  const yt = tutorialLinkYT(obj.n);
  const img = tutorialLinkIMG(obj.n);
  return `
    <div class="exercise">
      <div class="exBody">
        <div class="sketch">${sketchSVG(sketchType || "mob")}</div>
        <div class="exText">
          <div class="topLine">
            <div><b>${obj.n}</b></div>
            <div class="icons">
              <span class="badge">${sketchType || "tech"}</span>
            </div>
          </div>
          ${extraLine ? `<div class="small" style="margin-top:4px">${extraLine}</div>` : ``}
          <div class="small" style="margin-top:6px">Nota tecnica: ${obj.note}</div>

          <!-- TUTORIALS (richiesto) -->
          <div class="small linkRow">
            <a href="${yt}" target="_blank" rel="noopener">â–¶ YouTube</a>
            <a href="${img}" target="_blank" rel="noopener">ðŸ–¼ Immagini</a>
          </div>
        </div>
      </div>
    </div>
  `;
}

/* ===========================
   SESSION BUILD (stabile per oggi + mode + runDay)
=========================== */
let todaySession = null;

function buildTodaySession(){
  const sug = calcSuggestion();

  const warmCount = (sug.mode===25) ? 3 : 4;
  const mobCount  = (sug.mode===25) ? 2 : 3;
  const coreMobCount = 2;

  const training = DB.training.slice();
  const pull = training.filter(x=>x.t==="pull");
  const push = training.filter(x=>x.t==="push");
  const hinge = training.filter(x=>x.t==="hinge");
  const core = training.filter(x=>x.t==="core");

  let hingeCount = Math.max(1, Math.round(sug.trainingCount*0.25));
  let coreCount  = Math.max(1, Math.round(sug.trainingCount*0.15));
  let upperCount = sug.trainingCount - hingeCount - coreCount;

  if(sug.runDay){
    hingeCount = Math.max(1, hingeCount - 1);
    upperCount = sug.trainingCount - hingeCount - coreCount;
  }

  const pickedWarm = pickStable("warm", DB.warm, warmCount);
  const pickedMob  = pickStable("mobility", DB.mobility, mobCount);
  const pickedCoreMob = pickStable("coreMobility", DB.coreMobility, coreMobCount);

  const pickedPull = pickStable("train_pull", pull, Math.floor(upperCount/2));
  const pickedPush = pickStable("train_push", push, upperCount - pickedPull.length);
  const pickedHinge = pickStable("train_hinge", hinge, hingeCount);
  const pickedCore = pickStable("train_core", core, coreCount);

  let mergedTraining = [];
  let i=0,j=0,k=0,m=0;
  while(mergedTraining.length < sug.trainingCount){
    if(i < pickedPull.length) mergedTraining.push(pickedPull[i++]);
    if(j < pickedPush.length && mergedTraining.length < sug.trainingCount) mergedTraining.push(pickedPush[j++]);
    if(m < pickedCore.length && mergedTraining.length < sug.trainingCount) mergedTraining.push(pickedCore[m++]);
    if(k < pickedHinge.length && mergedTraining.length < sug.trainingCount) mergedTraining.push(pickedHinge[k++]);
    if(i>=pickedPull.length && j>=pickedPush.length && k>=pickedHinge.length && m>=pickedCore.length) break;
  }
  mergedTraining = mergedTraining.slice(0, sug.trainingCount);

  const pickedStretch = pickStable("stretch", DB.stretch, 1);

  const pairHints = [];
  for(let p=0; p<mergedTraining.length-1; p+=2){
    pairHints.push([mergedTraining[p].n, mergedTraining[p+1].n]);
  }

  return {
    date: today(),
    suggestion: sug,
    warm: pickedWarm,
    mobility: pickedMob,
    coreMobility: pickedCoreMob,
    training: mergedTraining,
    trainingPairs: pairHints,
    stretch: pickedStretch
  };
}

function renderProgram(){
  const container = document.getElementById("program");
  container.innerHTML = "";

  const mode = document.getElementById("mode").value;
  const runDay = document.getElementById("runDay").checked ? "1" : "0";
  const cacheKey = `session_${today()}_${mode}_${runDay}`;

  const cached = localStorage.getItem(cacheKey);
  if(cached){
    try{ todaySession = JSON.parse(cached); } catch(e){ todaySession = null; }
  }
  if(!todaySession || todaySession.date !== today()){
    todaySession = buildTodaySession();
    localStorage.setItem(cacheKey, JSON.stringify(todaySession));
  }

  const sug = todaySession.suggestion;
  document.getElementById("cycleW").innerText = String(sug.weekInCycle);
  document.getElementById("streak").innerText = String(data.streak||0);
  document.getElementById("totalW").innerText = String(data.totalWorkouts||0);

  const sq = document.getElementById("doneSquare");
  if(data.completedDate===today()) sq.classList.add("done"); else sq.classList.remove("done");

  container.innerHTML += sectionHeader("MobilitÃ  / Riscaldamento", "warm");
  const warmLine = `<b>Metronomo attivo</b> (2â€“1â€“2). Ritmo tecnico, senza affanno.`;
  todaySession.warm.forEach(x=>{
    container.innerHTML += exerciseCard(x, warmLine, "mob");
  });
  todaySession.mobility.forEach(x=>{
    container.innerHTML += exerciseCard(x, "MobilitÃ : range controllato, niente dolore.", "mob");
  });
  todaySession.coreMobility.forEach(x=>{
    container.innerHTML += exerciseCard(x, "Core-stability: qualitÃ  > quantitÃ . Respira.", "core");
  });

  container.innerHTML += sectionHeader("Allenamento", "train");
  container.innerHTML += `<div class="small" style="text-align:left;margin:6px 0 10px 0">
    Banda consigliata: <b>${sug.band}kg</b> Â· Reps target: <b>${sug.reps}</b> Â· Cicli: <b>${sug.cycles}</b> Â· Durata: <b>${sug.mode}â€™</b>
    ${sug.runDay ? ` Â· <b>Giorno corsa</b>: riduzione hinge.` : ``}
    <br>Schema consigliato: alterna a coppie <b>AB</b> (es. 1â†”2, 3â†”4) senza pause lunghe.
  </div>`;

  if(todaySession.trainingPairs.length){
    const pairsTxt = todaySession.trainingPairs.map(p=>`(${p[0]} â†” ${p[1]})`).join(" Â· ");
    container.innerHTML += `<div class="small" style="text-align:left;margin:-2px 0 10px 0">Coppie: ${pairsTxt}</div>`;
  }

  todaySession.training.forEach(x=>{
    const kind = (x.t==="pull") ? "pull" : (x.t==="push") ? "push" : (x.t==="hinge") ? "hinge" : "core";
    const extra = `Banda: <b>${sug.band}kg</b> Â· Reps: <b>${sug.reps}</b> Â· Cicli: <b>${sug.cycles}</b>`;
    container.innerHTML += exerciseCard({n:x.n, note:x.note}, extra, kind);
  });

  container.innerHTML += sectionHeader("Allungamento / Rilassamento", "stretch");
  todaySession.stretch.forEach(x=>{
    container.innerHTML += exerciseCard(x, "<b>Metronomo 30s</b> in rilassamento: respira lento.", "mob");
  });
}

/* ===========================
   TIMER + METRONOMO
=========================== */
let phases=[];
let current=0;
let timer=null;
let audioCtx=null;
let gainNode=null;

function initAudio(){
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  gainNode=audioCtx.createGain();
  gainNode.gain.value=0.01;
  gainNode.connect(audioCtx.destination);
}
function beep(){
  if(!audioCtx) initAudio();
  const osc=audioCtx.createOscillator();
  osc.type="sine";
  osc.frequency.value=520;
  osc.connect(gainNode);
  osc.start();
  osc.stop(audioCtx.currentTime+0.04);
}

function buildPhases(){
  const mode=parseInt(document.getElementById("mode").value,10);
  const total = mode*60;

  let warmT = Math.round(total*0.03);
  let mobT  = Math.round(total*0.02);
  let trainT= Math.round(total*0.94);
  let coreT = Math.round(total*0.02);
  let stretchT = Math.round(total*0.03);

  warmT = Math.max(60, warmT);
  mobT  = Math.max(45, mobT);
  coreT = Math.max(45, coreT);
  stretchT = Math.max(30, stretchT);

  let sum = warmT+mobT+trainT+coreT+stretchT;
  if(sum !== total){
    trainT = Math.max(60, trainT - (sum-total));
  }

  const pause = 30;
  const available = Math.max(60, trainT - (pause*2));
  const block = Math.floor(available/3);

  phases = [
    {name:"Riscaldamento (metronomo)", time:warmT, beep:true},
    {name:"MobilitÃ ", time:mobT, beep:false},
    {name:"Allenamento â€” Blocco 1", time:block, beep:false},
    {name:"Pausa", time:pause, beep:false},
    {name:"Allenamento â€” Blocco 2", time:block, beep:false},
    {name:"Pausa", time:pause, beep:false},
    {name:"Allenamento â€” Blocco 3", time:block, beep:false},
    {name:"Core / Controllo", time:coreT, beep:false},
    {name:"Rilassamento (30s metronomo)", time:30, beep:true}
  ];

  const residualStretch = stretchT - 30;
  if(residualStretch > 0){
    phases.push({name:"Stretch (senza metronomo)", time:residualStretch, beep:false});
  }
}

function startSession(){
  buildPhases();
  current=0;
  runPhase();
}
function runPhase(){
  if(timer){clearInterval(timer); timer=null;}
  if(current>=phases.length){
    document.getElementById("phase").innerText="Finito";
    document.getElementById("timeLeft").innerText="â€”";
    return;
  }
  const p=phases[current];
  let t=p.time;
  document.getElementById("phase").innerText=p.name;
  document.getElementById("timeLeft").innerText=t+" sec";

  timer=setInterval(()=>{
    t--;
    document.getElementById("timeLeft").innerText=t+" sec";
    if(p.beep) beep();
    if(t<=0){
      clearInterval(timer); timer=null;
      current++;
      runPhase();
    }
  },1000);
}
function nextPhase(){
  if(timer){clearInterval(timer); timer=null;}
  current++;
  runPhase();
}

/* ===========================
   COMPLETE + RPE progression + 4-week
=========================== */
function completeWorkout(){
  if(data.completedDate===today()){
    alert("GiÃ  completato oggi.");
    return;
  }

  if(data.completedDate){
    const prev=new Date(data.completedDate+"T00:00:00");
    const cur=new Date(today()+"T00:00:00");
    const diffDays=Math.round((cur-prev)/(1000*60*60*24));
    data.streak = (diffDays===1) ? (data.streak+1) : 1;
  }else{
    data.streak = 1;
  }

  data.completedDate = today();
  data.totalWorkouts = (data.totalWorkouts||0) + 1;

  const rpe = parseInt(document.getElementById("sessionRPE").value,10);
  const w = weekInCycle();

  const last1 = data.logs.length ? data.logs[0].sessionRPE : null;

  let base = data.baseReps || 12;
  let bandIdx = data.bandIndex || 0;

  if(w===4){
    if(rpe>=2) base = Math.max(8, base - 2);
  }else{
    if(rpe===3){
      base = Math.max(8, base - 2);
    }else if(rpe===1){
      if(last1===1){
        if(base < 18){
          base = Math.min(18, base + 2);
        }else{
          if(bandIdx < 2){
            bandIdx += 1;
            base = 12;
          }
        }
      }
    }
  }

  data.baseReps = base;
  data.bandIndex = bandIdx;

  const sug = calcSuggestion();
  const mode = parseInt(document.getElementById("mode").value,10);
  const runDay = document.getElementById("runDay").checked;

  data.logs.unshift({
    date: today(),
    mode,
    runDay,
    weekInCycle: sug.weekInCycle,
    sessionRPE: rpe,
    suggestion: { band: sug.band, reps: sug.reps, cycles: sug.cycles, trainingCount: sug.trainingCount },
    session: todaySession
  });
  data.logs = data.logs.slice(0, 120);

  save();
  generateWorkout();
  alert("Allenamento registrato. Progressione aggiornata.");
}

/* ===========================
   EXPORT / COPY
=========================== */
function exportLog(){
  const payload = {
    app:"Workout100",
    exportedAt: new Date().toISOString(),
    stats: {streak:data.streak, totalWorkouts:data.totalWorkouts, baseReps:data.baseReps, bandIndex:data.bandIndex},
    logs: data.logs
  };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `workout100_log_${today()}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function copyTodayToClipboard(){
  const payload = { date: today(), suggestion: calcSuggestion(), session: todaySession };
  const txt = JSON.stringify(payload, null, 2);
  navigator.clipboard.writeText(txt).then(()=>{
    alert("Sessione di oggi copiata (JSON) negli appunti.");
  }).catch(()=>{
    alert("Impossibile copiare. Usa 'Esporta log (JSON)'.");
  });
}

/* ===========================
   INIT
=========================== */
function generateWorkout(){
  renderProgram();
  document.getElementById("streak").innerText = String(data.streak||0);
  document.getElementById("totalW").innerText = String(data.totalWorkouts||0);
  document.getElementById("cycleW").innerText = String(weekInCycle());
  const sq = document.getElementById("doneSquare");
  if(data.completedDate===today()) sq.classList.add("done"); else sq.classList.remove("done");
}
generateWorkout();
</script>

</body>
</html>
