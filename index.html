<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Workout 100</title>

<style>
:root{
--bg:#0f1115; 
--panel:#151924; 
--text:#e8e8e8; 
--muted:#a8b0c0; 
--line:#2a3142;
--accent:#4da6ff; 
--ok:#25d366; 
--warn:#f5c542; 
--danger:#ff5c5c;
}

body{
font-family:Arial,system-ui;
background:var(--bg);
color:var(--text);
margin:0;
padding:14px;
}

.card{
background:var(--panel);
border:1px solid var(--line);
border-radius:10px;
padding:10px;
margin:10px auto;
max-width:980px;
}

.exercise{
border:1px solid var(--line);
border-radius:10px;
padding:10px;
margin:8px 0;
background:#0b0d12;
}

button{cursor:pointer}
.logBox{white-space:pre-wrap}
</style>

</head>
<body>

<h1>Workout 100</h1>

<div class="card">
Durata:
<select id="mode">
<option value="25">25 minuti</option>
<option value="35">35 minuti</option>
</select>

RPE:
<select id="rpeGlobal">
<option value="1">1 = facile</option>
<option value="2" selected>2 = ok</option>
<option value="3">3 = duro</option>
</select>

<button id="regenBtn">Rigenera (oggi)</button>
<button id="completeBtn">Allenamento completato</button>
</div>

<div class="card">
<div id="program"></div>
</div>

<div class="card">
<div class="logBox" id="logBox"></div>
</div>

<!-- ðŸ”¹ QUI carichi il motore tecnico -->
<script src="studyEngine.js"></script>

<!-- ðŸ”¹ QUI va il tuo codice principale -->
<script>
let exerciseDB = null;

// qui metti tutto il resto del tuo codice

/* ==========================
   DB
========================== */

let exerciseDB = null;

async function loadDB() {
  try {
    const res = await fetch("exercises.json", { cache: "no-store" });

    if (!res.ok) {
      throw new Error("HTTP " + res.status);
    }

    exerciseDB = await res.json();

    console.log("DB caricato correttamente");
    boot();

  } catch (e) {

    console.error("Errore caricamento exercises.json:", e);

    const programDiv = document.getElementById("program");
    if (programDiv) {
      programDiv.innerHTML =
        "<b>Errore caricamento exercises.json</b><br>" + e.message;
    }
  }
}
/* ==========================
   STORAGE
========================== */

const STORAGE_KEY = "workout100_v9";

const DEFAULT_DATA = {
  startDate: new Date().toISOString().split("T")[0],
  lastGeneratedKey: null,
  dayPicks: null,
  completedDate: null,
  streak: 0,
  prog: {
    upper: { band: 15, repIndex: 2 },
    core:  { band: 15, repIndex: 1 },
    lower: { band: 15, repIndex: 1 }
  },
  history: {},
  sessions: []
};

/* ---------- LOAD ---------- */

function loadData() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);

    if (!raw) {
      return structuredClone(DEFAULT_DATA);
    }

    const parsed = JSON.parse(raw);

    // Merge sicuro per evitare campi mancanti
    return {
      ...structuredClone(DEFAULT_DATA),
      ...parsed,
      prog: {
        ...structuredClone(DEFAULT_DATA.prog),
        ...(parsed.prog || {})
      },
      history: parsed.history || {},
      sessions: parsed.sessions || []
    };

  } catch (e) {
    console.warn("Errore lettura localStorage, reset dati:", e);
    return structuredClone(DEFAULT_DATA);
  }
}

/* ---------- SAVE ---------- */

function saveData() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  } catch (e) {
    console.error("Errore salvataggio localStorage:", e);
  }
}

/* ---------- INIT ---------- */

let data = loadData();

/* ==========================
   UTILS
========================== */

const REPS_OPTIONS=[8,10,12,14,16,18,20];
const BANDS=[15,25,35];
const TEMPO="2-1-2";

function clamp(n,min,max){return Math.max(min,Math.min(max,n));}
function today(){return new Date().toISOString().split("T")[0];}
function daysBetween(d1,d2){return Math.floor((new Date(d2)-new Date(d1))/86400000);}

/* ==========================
   WORKOUT ENGINE
========================== */

const WorkoutEngine = {

  /* -------- PROGRESSIONE -------- */

  getSuggested(data, family, mode) {

    const phase = Math.floor(daysBetween(data.startDate, today()) / 7) % 4;
    const p = data.prog[family] || { band: 15, repIndex: 2 };

    let repIndex = p.repIndex;
    let band = p.band;

    if (mode === "35") repIndex++;
    if (phase === 1) repIndex++;
    if (phase === 3) repIndex--;

    repIndex = clamp(repIndex, 0, REPS_OPTIONS.length - 1);

    return {
      band,
      reps: REPS_OPTIONS[repIndex],
      repIndex
    };
  },

  applyProgression(data, family, repsDone, repsTarget, rpe) {

    let p = data.prog[family] || { band: 15, repIndex: 2 };
    let bi = BANDS.indexOf(p.band);
    if (bi < 0) bi = 0;

    if (rpe === 1 && repsDone >= repsTarget) {
      if (p.repIndex < REPS_OPTIONS.length - 1) {
        p.repIndex++;
      } else if (bi < BANDS.length - 1) {
        bi++;
        p.band = BANDS[bi];
        p.repIndex = 1;
      }
    }

    if (rpe === 3 && repsDone < repsTarget) {
      if (p.repIndex > 0) {
        p.repIndex--;
      } else if (bi > 0) {
        bi--;
        p.band = BANDS[bi];
        p.repIndex = 1;
      }
    }

    data.prog[family] = p;
  }

};

/* ==========================
   BUILD PROGRAM
========================== */

let picks = [];

/* -------- GENERAZIONE -------- */

function buildProgram() {

  if (!exerciseDB || !exerciseDB.training) {
    console.error("exerciseDB non caricato o struttura errata");
    return;
  }

  const mode = document.getElementById("mode").value;

  // Numero esercizi dinamico
  const targetCount = mode === "35" ? 7 : 5;

  // Random semplice ma stabile per sessione
  picks = [...exerciseDB.training]
    .sort(() => 0.5 - Math.random())
    .slice(0, targetCount);

  renderProgram();
}

/* -------- RENDER -------- */

function renderProgram() {

  const container = document.getElementById("program");
  container.innerHTML = "";

  if (!picks || picks.length === 0) {
    container.innerHTML = "<b>Nessun esercizio disponibile</b>";
    return;
  }

  const mode = document.getElementById("mode").value;

  picks.forEach(ex => {

    const fam = ex.family || "core";
    const sug = WorkoutEngine.getSuggested(data, fam, mode);

    // Analisi tecnica tramite StudyEngine
    let analysis = null;
    if (typeof StudyEngine !== "undefined" && StudyEngine.analyzeExercise) {
      analysis = StudyEngine.analyzeExercise(ex);
    }

    container.innerHTML += `
      <div class="exercise">
        <b>${ex.name}</b><br>

        ${analysis ? `
        Pattern: ${analysis.pattern}<br>
        Carico rachide: ${analysis.spinalLoad}<br>
        Evidenza: ${analysis.evidenceTag}<br>
        ` : ""}

        Banda: ${sug.band} kg<br>
        Target reps: ${sug.reps}<br>

        <select class="didReps">
          ${REPS_OPTIONS.map(r =>
            `<option ${r === sug.reps ? "selected" : ""}>${r}</option>`
          ).join("")}
        </select>
      </div>
    `;

  });

}
/* ==========================
   COMPLETE
========================== */

function completeWorkout(){

  if (!picks || picks.length === 0) {
    alert("Nessun esercizio da salvare.");
    return;
  }

  const mode = document.getElementById("mode").value;
  const rpe = parseInt(document.getElementById("rpeGlobal").value, 10);

  if (isNaN(rpe)) {
    alert("RPE non valido.");
    return;
  }

  const exEls = document.querySelectorAll(".exercise");
  const sessionExercises = [];

  exEls.forEach((el, i) => {

    const ex = picks[i];
    if (!ex) return;

    const select = el.querySelector(".didReps");
    if (!select) return;

    const repsDone = parseInt(select.value, 10);
    const fam = ex.family || "core";
    const sug = WorkoutEngine.getSuggested(data, fam, mode);

    // Progressione
    WorkoutEngine.applyProgression(data, fam, repsDone, sug.reps, rpe);

    // Salvataggio dettagliato
    sessionExercises.push({
      name: ex.name,
      family: fam,
      repsTarget: sug.reps,
      repsDone,
      band: sug.band
    });

  });

  // Salva sessione completa
  data.sessions.push({
    date: today(),
    mode,
    rpe,
    exercises: sessionExercises
  });

  saveData();
  updateLog();

  alert("Allenamento salvato.");

}

/* ==========================
   LOG
========================== */

function updateLog(){

  if (!data.sessions || data.sessions.length === 0) {
    document.getElementById("logBox").innerText = "Nessuna sessione salvata.";
    return;
  }

  const last = data.sessions[data.sessions.length - 1];

  document.getElementById("logBox").innerText =
    JSON.stringify(last, null, 2);
}
</script>

   
</body>
</html>
