<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Workout 100</title>

<style>
:root{
  --bg:#0f1115; --panel:#151924; --text:#e8e8e8; --muted:#a8b0c0; --line:#2a3142;
  --accent:#4da6ff; --ok:#25d366; --warn:#f5c542;
}

body{
  font-family:Arial,system-ui;
  background:var(--bg);
  color:var(--text);
  margin:0;
  padding:10px;
}

h1{margin:6px 0 10px; font-size:20px}

.card{
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:10px;
  padding:10px;
  margin:8px auto;
  max-width:980px;
}

.card.controls{
  position:sticky;
  top:6px;
  z-index:10;
  box-shadow:0 6px 20px rgba(0,0,0,.22);
}

.controlsRow{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:flex-end;
}

.field{
  display:flex;
  flex-direction:column;
  gap:4px;
  min-width:96px;
}

label{font-size:12px; color:var(--muted);}

select, button{
  border:1px solid var(--line);
  background:#0b0d12;
  color:var(--text);
  border-radius:10px;
  padding:10px;
  font-size:14px;
}

button{cursor:pointer}
.actions{
  margin-left:auto;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:flex-end;
}
.iconBtn{
  width:46px;
  padding:10px 0;
  font-size:18px;
  font-weight:700;
}

.toggleRow{margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;}
.toggleRow label{display:flex; gap:8px; align-items:center; font-size:13px; color:var(--muted);}

.small{color:var(--muted); font-size:12px; line-height:1.35}

.exercise{
  border:1px solid var(--line);
  border-radius:10px;
  padding:10px;
  margin:8px 0;
  background:#0b0d12;
}

.sectionTitle{margin:12px 0 6px; font-weight:700;}
.hr{height:1px; background:var(--line); margin:10px 0;}

.exerciseHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

.videoLink{
  border:1px solid var(--line);
  background:#0b0d12;
  border-radius:10px;
  padding:8px 10px;
  font-size:14px;
  color:var(--accent);
  text-decoration:none;
  white-space:nowrap;
}
.videoLink:hover{text-decoration:underline}

.cuesList{margin:8px 0 0; padding-left:18px;}
.cuesList li{margin:4px 0; font-size:13px; line-height:1.3;}

select.didReps{margin-top:8px; width:100%;}

@media (max-width:560px){
  body{padding:8px}
  h1{font-size:18px;margin:6px 0 8px}
  .card{padding:9px;margin:7px auto}

  .card.controls{padding:8px}
  .controlsRow{gap:6px}
  .field{min-width:80px; flex:1 1 90px}

  /* Controlli più compatti per vedere 1–2 esercizi */
  select,button{padding:8px 10px; font-size:15px}
  .actions{width:100%; margin-left:0}
  #completeBtn{flex:1 1 auto}
  .iconBtn{width:44px}

  .toggleRow{gap:8px; margin-top:8px}
  .toggleRow label{font-size:12px}
}
</style>
</head>

<body>
<h1>Workout 100</h1>

<div class="card controls">
  <div class="controlsRow">
    <div class="field">
      <label>Durata</label>
      <select id="mode">
        <option value="25">25</option>
        <option value="35">35</option>
      </select>
    </div>

    <div class="field">
      <label>RPE</label>
      <select id="rpeGlobal">
        <option value="1">1</option>
        <option value="2" selected>2</option>
        <option value="3">3</option>
      </select>
    </div>

    <div class="field">
      <label>Banda</label>
      <select id="bandBase">
        <option value="15">15</option>
        <option value="25" selected>25</option>
        <option value="35">35</option>
      </select>
    </div>

    <div class="actions">
      <!-- Cambia proposta: disponibile SOLO finché non completi la sessione di oggi -->
      <button id="shuffleBtn" class="iconBtn" title="Cambia proposta per oggi">↻</button>
      <button id="completeBtn">Allenamento completato</button>
    </div>
  </div>

  <div class="toggleRow">
    <label><input type="checkbox" id="runDay" /> Giorno corsa/bici</label>
    <label><input type="checkbox" id="fasting" /> Digiuno</label>
    <label><input type="checkbox" id="noAnchor" checked /> No appigli/ancoraggi</label>
  </div>

  <div class="small" id="statusLine" style="margin-top:8px"></div>
</div>

<div class="card">
  <div id="program"></div>
</div>

<div class="card">
  <div class="small" id="logBox"></div>
</div>

<!-- Motori -->
<script src="studyEngine.js"></script>
<script src="biomechanicalEngine.js"></script>
<script src="sessionengine1.js"></script>

<script>
/* ==========================
   DB
========================== */
let exerciseDB = null;

async function loadDB(){
  try{
    const res = await fetch("exercises.json", { cache:"no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    exerciseDB = await res.json();
    if(!exerciseDB || !Array.isArray(exerciseDB.training)){
      throw new Error("Struttura JSON errata: manca 'training' (array).");
    }
    boot();
  }catch(err){
    console.error(err);
    const programDiv=document.getElementById("program");
    if(programDiv){
      programDiv.innerHTML = "<b>Errore exercises.json</b><br><span class='small'>"+escapeHtml(err.message||String(err))+"</span>";
    }
  }
}

/* ==========================
   STORAGE
========================== */
const STORAGE_KEY="workout100_v15";

const DEFAULT_DATA = {
  startDate: new Date().toISOString().split("T")[0],
  completedDate: null,
  streak: 0,
  sessions: [],
  todayDraft: null,     // bozza sessione (modificabile) per oggi
  todaySaved: null,     // sessione salvata (bloccata) per oggi
  todayNonce: 0,        // cambia "proposta" finché non completi
  todayKey: null
};

function deepClone(obj){
  if(typeof structuredClone==="function") return structuredClone(obj);
  return JSON.parse(JSON.stringify(obj));
}

function loadData(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw) return deepClone(DEFAULT_DATA);
    const p=JSON.parse(raw);
    return { ...deepClone(DEFAULT_DATA), ...p, sessions: Array.isArray(p.sessions)?p.sessions:[] };
  }catch(e){
    return deepClone(DEFAULT_DATA);
  }
}

function saveData(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

let data = loadData();

/* ==========================
   UTILS
========================== */
const REPS_OPTIONS=[8,10,12,14,16,18,20];

function today(){return new Date().toISOString().split("T")[0];}
function daysBetween(d1,d2){return Math.floor((new Date(d2)-new Date(d1))/86400000);}

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function uniq(arr){
  const out=[], seen=new Set();
  (arr||[]).forEach(x=>{
    const s=String(x||"").trim();
    if(!s) return;
    if(seen.has(s)) return;
    seen.add(s); out.push(s);
  });
  return out;
}

/* ==========================
   NO-ANCHOR FILTER
========================== */
function buildNoAnchorQuery(base){
  return `${base} elastico sotto piedi senza ancoraggio senza appigli no door anchor no pull up bar`;
}

function isAnchorExercise(ex){
  if (ex && ex.requiresAnchor === true) return true;
  if (ex && ex.noAnchorOk === true) return false;

  const n = (ex && ex.name ? ex.name : String(ex||"")).toLowerCase();
  const patterns = [
    "anchor","anchoring","door","porta","door anchor","ancoraggio","appiglio",
    "pull-up bar","pull up bar","sbarra","barra trazioni","chin-up","chin up",
    "cable","cavo","cavi","lat machine"
  ];
  return patterns.some(p => n.includes(p));
}

function videoLinkFromName(name, noAnchorOnly){
  const q = noAnchorOnly ? buildNoAnchorQuery(name) : (name + " tutorial");
  return "https://www.youtube.com/results?search_query=" + encodeURIComponent(q);
}

/* ==========================
   SEEDED RANDOM (stabile per oggi)
   - bozza stabile per data + opzioni + nonce
   - nonce aumenta con ↻ finché non completi
========================== */
function mulberry32(a){
  return function(){
    var t=a+=0x6D2B79F5;
    t=Math.imul(t^t>>>15,t|1);
    t^=t+Math.imul(t^t>>>7,t|61);
    return ((t^t>>>14)>>>0)/4294967296;
  };
}

function seedFromString(str){
  let n=0;
  for(let i=0;i<str.length;i++) n=(n*31 + str.charCodeAt(i))>>>0;
  return n>>>0;
}

function withSeededRandom(seed, fn){
  const old = Math.random;
  const rng = mulberry32(seed);
  Math.random = rng;
  try{ return fn(); }
  finally{ Math.random = old; }
}

/* ==========================
   EX NORMALIZE
========================== */
function normExercise(x, forcedFamily=null){
  if (!x) return null;
  if (typeof x === "string") {
    return { name:x, family:(forcedFamily||"core"), cues:[], link:null, prescription:null };
  }
  if (typeof x === "object" && x.name) {
    return {
      name: String(x.name),
      family: (forcedFamily || x.family || "core").toLowerCase(),
      cues: Array.isArray(x.cues) ? x.cues.map(String) : (x.cues ? [String(x.cues)] : []),
      link: x.link ? String(x.link) : null,
      prescription: x.prescription || x.rx || null,
      requiresAnchor: x.requiresAnchor === true,
      noAnchorOk: x.noAnchorOk === true
    };
  }
  return null;
}

function normalizeSessionLists(session){
  const warm = (session?.warm || session?.warmup || session?.warmUp || []).map(x=>normExercise(x,"warm")).filter(Boolean);
  const mobility = (session?.mobility || session?.mob || []).map(x=>normExercise(x,"mobility")).filter(Boolean);
  const strength = (session?.strength || session?.exercises || []).map(x=>normExercise(x)).filter(Boolean);
  return { warm, mobility, strength };
}

/* ==========================
   ENGINE HOOKS (CUES)
========================== */
function getEngineCues(ex, ctx){
  const out = [];

  try{
    if (window.BiomechanicalEngine){
      if (typeof BiomechanicalEngine.getCues === "function"){
        const c = BiomechanicalEngine.getCues(ex, ctx);
        if (Array.isArray(c)) out.push(...c);
      }
      if (typeof BiomechanicalEngine.analyzeExercise === "function"){
        const a = BiomechanicalEngine.analyzeExercise(ex, ctx);
        if (a){
          if (Array.isArray(a.cues)) out.push(...a.cues);
          if (Array.isArray(a.attentions)) out.push(...a.attentions);
          if (typeof a.notes === "string") out.push(a.notes);
        }
      }
    }
  }catch(e){}

  try{
    if (window.StudyEngine){
      if (typeof StudyEngine.getCues === "function"){
        const c = StudyEngine.getCues(ex, ctx);
        if (Array.isArray(c)) out.push(...c);
      }
      if (typeof StudyEngine.analyzeExercise === "function"){
        const a = StudyEngine.analyzeExercise(ex, ctx);
        if (a){
          if (Array.isArray(a.cues)) out.push(...a.cues);
          if (Array.isArray(a.attentions)) out.push(...a.attentions);
          if (typeof a.notes === "string") out.push(a.notes);
        }
      }
    }
  }catch(e){}

  return out.map(String);
}

function cuesFallbackByFamily(fam){
  if (fam === "upper") return ["Scapole stabili", "Collo neutro", "Costole giù", "Eccentrica controllata"];
  if (fam === "core")  return ["Brace addome", "Bacino neutro", "Respira senza perdere tensione", "Stop se dolore lombare"];
  if (fam === "lower") return ["Schiena neutra", "Ginocchia in linea", "Spinta da anche/glutei", "Caviglie stabili"];
  if (fam === "warm") return ["Ritmo fluido", "Range controllato", "Respirazione regolare"];
  if (fam === "mobility") return ["Lento e controllato", "Nessun dolore acuto", "Range progressivo", "Pausa respirazione a fine ROM"];
  return ["Tecnica prima del volume"];
}

function getDetailedCues(ex, ctx){
  const fam = (ex.family || "core").toLowerCase();
  const cues = uniq([
    ...(Array.isArray(ex.cues) ? ex.cues : []),
    ...getEngineCues(ex, ctx),
    ...cuesFallbackByFamily(fam)
  ]);
  return cues.slice(0, 12);
}

/* ==========================
   RX / PRESCRIPTION (delegato)
========================== */
function getRx(ex, ctx){
  const base = ex?.prescription || ex?.rx || null;
  if (base && typeof base === "object") return base;

  try{
    if (window.BiomechanicalEngine && typeof BiomechanicalEngine.getPrescription === "function"){
      const p = BiomechanicalEngine.getPrescription(ex, ctx);
      if (p && typeof p === "object") return p;
    }
  }catch(e){}

  try{
    if (window.StudyEngine && typeof StudyEngine.getPrescription === "function"){
      const p = StudyEngine.getPrescription(ex, ctx);
      if (p && typeof p === "object") return p;
    }
  }catch(e){}

  if (ctx.kind === "warm") return { cycles: 1, reps: 20 };
  if (ctx.kind === "mobility") return { cycles: 1, reps: 10 };
  if (ctx.kind === "strength") return { cycles: 2, band: parseInt(document.getElementById("bandBase")?.value || "25", 10), reps: 12 };
  return { cycles: 1, reps: 10 };
}

/* ==========================
   PROGRAM (draft/saved per oggi)
========================== */
let plan = { warm:[], mobility:[], strength:[] };

function computeTodayKey(){
  const mode = document.getElementById("mode").value;
  const band = document.getElementById("bandBase").value;
  const runDay = !!document.getElementById("runDay")?.checked;
  const fasting = !!document.getElementById("fasting")?.checked;
  const noAnchorOnly = !!document.getElementById("noAnchor")?.checked;
  // key stable (scientifico): data + opzioni + nonce
  return `${today()}|${mode}|b${band}|r${runDay?1:0}|f${fasting?1:0}|na${noAnchorOnly?1:0}|n${data.todayNonce||0}`;
}

function ensureTodayState(){
  const t = today();
  // se cambio giorno: reset draft/saved/nonce
  if(!data.todayKey || !data.todayKey.startsWith(t+"|")){
    data.todayDraft = null;
    data.todaySaved = null;
    data.todayNonce = 0;
    data.todayKey = null;
    saveData();
  }
}

function buildProgramFromEngines(){
  if(!window.SessionEngine || typeof SessionEngine.generateSession!=="function" || !exerciseDB){
    return null;
  }

  const mode = parseInt(document.getElementById("mode").value,10);
  const band = parseInt(document.getElementById("bandBase").value,10);
  const runDay = !!document.getElementById("runDay")?.checked;
  const fasting = !!document.getElementById("fasting")?.checked;

  const seedStr = computeTodayKey();
  const seed = seedFromString(seedStr);

  return withSeededRandom(seed, () => {
    return SessionEngine.generateSession(exerciseDB, {
      sessionMinutes: mode,
      runDay,
      fasting,
      band
    });
  });
}

function applyNoAnchorFilterToPlan(noAnchorOnly){
  if(!noAnchorOnly) return;
  plan.warm = plan.warm.filter(ex => !isAnchorExercise(ex));
  plan.mobility = plan.mobility.filter(ex => !isAnchorExercise(ex));
  plan.strength = plan.strength.filter(ex => !isAnchorExercise(ex));
}

function loadOrGenerateToday(){
  ensureTodayState();

  const noAnchorOnly = !!document.getElementById("noAnchor")?.checked;

  // Se oggi è già COMPLETATO: carica saved e blocca
  if(data.todaySaved && data.todaySaved.date === today()){
    plan = normalizeSessionLists(data.todaySaved.session);
    applyNoAnchorFilterToPlan(noAnchorOnly);
    renderProgram();
    updateStatusLine();
    setShuffleEnabled(false);
    updateLogBox();
    return;
  }

  // Altrimenti: usa draft se key coincide, altrimenti rigenera draft
  const key = computeTodayKey();

  if(data.todayDraft && data.todayDraft.key === key && data.todayDraft.session){
    plan = normalizeSessionLists(data.todayDraft.session);
    applyNoAnchorFilterToPlan(noAnchorOnly);
    renderProgram();
    updateStatusLine();
    setShuffleEnabled(true);
    updateLogBox();
    return;
  }

  const session = buildProgramFromEngines();
  if(!session){
    // fallback minimo
    const warmFallback = ["Inchworm","Jumping Jacks","Arm Circles","High Knees"];
    const mobFallback  = ["90/90 Hip Switch","Ankle Rock (knee to wall)","Cat-Cow","Thoracic Rotation (quadruped)"];
    const training = Array.isArray(exerciseDB?.training) ? exerciseDB.training : [];

    const fallbackSession = {
      warm: warmFallback.slice(0, document.getElementById("mode").value==="35" ? 3 : 2),
      mobility: mobFallback.slice(0,2),
      exercises: training.slice(0, document.getElementById("mode").value==="35" ? 8 : 6)
    };
    plan = normalizeSessionLists(fallbackSession);
  }else{
    plan = normalizeSessionLists(session);
  }

  applyNoAnchorFilterToPlan(noAnchorOnly);

  data.todayKey = key;
  data.todayDraft = { date: today(), key, session: session || null };
  saveData();

  renderProgram();
  updateStatusLine();
  setShuffleEnabled(true);
  updateLogBox();
}

function shuffleToday(){
  // Cambia proposta SOLO se non hai completato oggi
  if(data.todaySaved && data.todaySaved.date===today()) return;
  ensureTodayState();
  data.todayNonce = (data.todayNonce||0) + 1;
  data.todayDraft = null;
  data.todayKey = null;
  saveData();
  loadOrGenerateToday();
}

function setShuffleEnabled(enabled){
  const btn = document.getElementById("shuffleBtn");
  if(!btn) return;
  btn.disabled = !enabled;
  btn.style.opacity = enabled ? "1" : "0.45";
}

/* ==========================
   RENDER
========================== */
function renderProgram(){
  const container=document.getElementById("program");
  container.innerHTML="";

  const mode=document.getElementById("mode").value;
  const noAnchorOnly=!!document.getElementById("noAnchor")?.checked;

  container.innerHTML += `<div class="small">Warm-up → Mobilità → Forza</div><div class="hr"></div>`;

  container.innerHTML += `<div class="sectionTitle">Riscaldamento (${plan.warm.length})</div>`;
  plan.warm.forEach(ex => container.innerHTML += renderExerciseCard(ex, mode, "warm", noAnchorOnly));

  container.innerHTML += `<div class="sectionTitle">Mobilità (${plan.mobility.length})</div>`;
  plan.mobility.forEach(ex => container.innerHTML += renderExerciseCard(ex, mode, "mobility", noAnchorOnly));

  container.innerHTML += `<div class="sectionTitle">Forza (${plan.strength.length})</div>`;
  plan.strength.forEach((ex, i) => container.innerHTML += renderExerciseCard(ex, mode, "strength", noAnchorOnly, i));
}

function renderExerciseCard(ex, mode, kind, noAnchorOnly, index){
  const fam = (ex.family || (kind==="strength" ? "core" : kind)).toLowerCase();
  const rx = getRx(ex, { mode, kind, family:fam });
  const cues = getDetailedCues(ex, { mode, kind, family:fam });

  const link = ex.link ? ex.link : videoLinkFromName(ex.name, noAnchorOnly);

  let rxText = "";
  if (kind === "warm" || kind === "mobility") {
    const cycles = rx?.cycles ?? 1;
    const reps = rx?.reps ?? (kind==="warm" ? 20 : 10);
    rxText = `<div class="small" style="margin-top:8px"><b>Rx:</b> ${cycles} × ${reps} reps</div>`;
  }

  let strengthHTML = "";
  if (kind === "strength") {
    const cycles = rx?.cycles ?? 2;
    const band = rx?.band ?? parseInt(document.getElementById("bandBase")?.value || "25", 10);
    const repsTarget = rx?.reps ?? 12;

    strengthHTML = `
      <div class="small" style="margin-top:8px">
        <b>Rx:</b> ${cycles} × ${repsTarget} reps • Banda <b>${band}</b>
      </div>

      <div class="small" style="margin-top:8px">Reps fatte</div>
      <select class="didReps" data-index="${index}">
        ${REPS_OPTIONS.map(r => `<option ${r === repsTarget ? "selected" : ""}>${r}</option>`).join("")}
      </select>
    `;
  }

  return `
    <div class="exercise" data-kind="${kind}">
      <div class="exerciseHeader">
        <b>${escapeHtml(ex.name)}</b>
        <a class="videoLink" href="${link}" target="_blank" rel="noopener">Video</a>
      </div>

      <span class="small">Family: ${escapeHtml(fam)}</span>
      ${rxText}

      <div class="small" style="margin-top:10px"><b>Attenzioni</b></div>
      <ul class="cuesList">
        ${cues.map(c=>`<li>${escapeHtml(c)}</li>`).join("")}
      </ul>

      ${strengthHTML}
    </div>
  `;
}

/* ==========================
   COMPLETE
========================== */
function completeWorkout(){
  if (!plan || !plan.strength || plan.strength.length === 0) {
    alert("Nessun esercizio forza da salvare.");
    return;
  }

  const mode = document.getElementById("mode").value;
  const rpe = parseInt(document.getElementById("rpeGlobal").value, 10);
  if (isNaN(rpe)) { alert("RPE non valido."); return; }

  const t = today();
  const noAnchorOnly = !!document.getElementById("noAnchor")?.checked;

  const exEls = document.querySelectorAll(".exercise[data-kind='strength']");
  const sessionExercises = [];

  exEls.forEach((el, i) => {
    const ex = plan.strength[i];
    if (!ex) return;
    const select = el.querySelector(".didReps");
    if (!select) return;

    const repsDone = parseInt(select.value, 10);
    const fam = ex.family || "core";
    const rx = getRx(ex, { mode, kind:"strength", family:fam });

    sessionExercises.push({
      name: ex.name,
      family: fam,
      repsTarget: rx?.reps ?? null,
      repsDone: Number.isFinite(repsDone) ? repsDone : null,
      band: rx?.band ?? null,
      cycles: rx?.cycles ?? null,
      video: ex.link ? ex.link : videoLinkFromName(ex.name, noAnchorOnly)
    });
  });

  // streak
  if (data.completedDate) {
    const diff = daysBetween(data.completedDate, t);
    data.streak = (diff === 1) ? (data.streak + 1) : 1;
  } else {
    data.streak = 1;
  }
  data.completedDate = t;

  const payload = {
    date: t,
    mode,
    rpe,
    warm: plan.warm.map(x=>x.name),
    mobility: plan.mobility.map(x=>x.name),
    exercises: sessionExercises
  };

  // engines completion (optional)
  try{ if (window.StudyEngine && typeof StudyEngine.completeSession === "function") StudyEngine.completeSession(payload); }catch(e){}
  try{ if (window.BiomechanicalEngine && typeof BiomechanicalEngine.completeSession === "function") BiomechanicalEngine.completeSession(payload); }catch(e){}
  try{ if (window.SessionEngine && typeof SessionEngine.completeSession === "function") SessionEngine.completeSession(payload); }catch(e){}

  data.sessions.push(payload);

  // salva e BLOCCA per oggi
  data.todaySaved = { date: t, session: (data.todayDraft && data.todayDraft.session) ? data.todayDraft.session : { warm:payload.warm, mobility:payload.mobility, exercises:payload.exercises } };
  data.todayDraft = null;
  saveData();

  setShuffleEnabled(false);
  updateStatusLine();
  updateLogBox();

  alert("Allenamento salvato.");
}

/* ==========================
   STATUS + LOG
========================== */
function updateStatusLine(){
  const done = (data.completedDate === today());
  const streak = data.streak || 0;

  const sOK = !!(window.StudyEngine);
  const bOK = !!(window.BiomechanicalEngine);
  const seOK = !!(window.SessionEngine && typeof SessionEngine.generateSession === "function");

  const lockTxt = (data.todaySaved && data.todaySaved.date===today()) ? " (bloccato)" : " (bozza)";
  document.getElementById("statusLine").innerHTML =
    `Oggi: <b>${today()}</b>${lockTxt} — Completato: <b style="color:${done ? "var(--ok)" : "var(--warn)"}">${done ? "SÌ" : "NO"}</b> — Streak: <b>${streak}</b>` +
    `<br>Motori: Study(${sOK ? "OK" : "NO"}) • Bio(${bOK ? "OK" : "NO"}) • Session(${seOK ? "OK" : "NO"})`;
}

function updateLogBox(){
  const box = document.getElementById("logBox");
  if (!box) return;

  if (!data.sessions || data.sessions.length === 0) {
    box.innerText = "Nessuna sessione salvata.";
    return;
  }

  const last = data.sessions[data.sessions.length - 1];
  const lines = [];
  lines.push(`Ultima sessione: ${last.date} • ${last.mode} min • RPE ${last.rpe}`);
  lines.push(`Warm: ${(last.warm||[]).join(", ")}`);
  lines.push(`Mobility: ${(last.mobility||[]).join(", ")}`);
  lines.push(`Forza:`);
  (last.exercises||[]).forEach((e, idx)=>{
    lines.push(`${idx+1}. ${e.name}  band:${e.band ?? "-"}  rx:${e.repsTarget ?? "-"}×${e.cycles ?? "-"}  fatto:${e.repsDone ?? "-"}`);
  });

  box.innerHTML =
    `<div class="small">${escapeHtml(lines.join("\n"))}</div>
     <div class="hr"></div>
     <details>
       <summary class="small">Mostra JSON</summary>
       <div class="small" style="margin-top:8px">${escapeHtml(JSON.stringify(last, null, 2))}</div>
     </details>`;
}

/* ==========================
   BOOT
========================== */
function boot(){
  document.getElementById("completeBtn").addEventListener("click", completeWorkout);
  document.getElementById("shuffleBtn").addEventListener("click", shuffleToday);

  // Cambi opzioni => nuova bozza stabile (reset nonce a 0)
  const rerollByOption = () => {
    if (data.todaySaved && data.todaySaved.date===today()) return;
    ensureTodayState();
    data.todayNonce = 0;
    data.todayDraft = null;
    data.todayKey = null;
    saveData();
    loadOrGenerateToday();
  };

  document.getElementById("mode").addEventListener("change", rerollByOption);
  document.getElementById("bandBase").addEventListener("change", rerollByOption);
  document.getElementById("runDay").addEventListener("change", rerollByOption);
  document.getElementById("fasting").addEventListener("change", rerollByOption);
  document.getElementById("noAnchor").addEventListener("change", rerollByOption);

  loadOrGenerateToday();
  updateStatusLine();
  updateLogBox();
}

document.addEventListener("DOMContentLoaded", loadDB);
</script>

</body>
</html>
