<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Workout 100</title>

<style>
:root{
  --bg:#0f1115; 
  --panel:#151924; 
  --text:#e8e8e8; 
  --muted:#a8b0c0; 
  --line:#2a3142;
  --accent:#4da6ff; 
  --ok:#25d366; 
  --warn:#f5c542; 
  --danger:#ff5c5c;
}

body{
  font-family:Arial,system-ui;
  background:var(--bg);
  color:var(--text);
  margin:0;
  padding:12px;
}

.card{
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:10px;
  padding:10px;
  margin:10px auto;
  max-width:900px;
}

.controls{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:flex-end;
}

.field{
  display:flex;
  flex-direction:column;
  gap:4px;
}

label{
  font-size:12px;
  color:var(--muted);
}

select,button{
  border:1px solid var(--line);
  background:#0b0d12;
  color:var(--text);
  border-radius:8px;
  padding:8px;
  font-size:14px;
}

button{cursor:pointer}

.exercise{
  border:1px solid var(--line);
  border-radius:10px;
  padding:10px;
  margin:8px 0;
  background:#0b0d12;
}

.sectionTitle{
  margin-top:14px;
  font-weight:700;
}

.cues{
  font-size:13px;
  color:var(--muted);
  margin-top:6px;
}

@media(max-width:600px){
  select,button{width:100%}
}
</style>
</head>
<body>

<h2>Workout 100</h2>

<div class="card">
  <div class="controls">
    <div class="field">
      <label>Durata</label>
      <select id="mode">
        <option value="25">25 minuti</option>
        <option value="35">35 minuti</option>
      </select>
    </div>

    <div class="field">
      <label>RPE finale</label>
      <select id="rpe">
        <option value="1">1 = facile</option>
        <option value="2" selected>2 = ok</option>
        <option value="3">3 = duro</option>
      </select>
    </div>

    <button id="btnGen">Genera sessione</button>
    <button id="btnComplete">Allenamento completato</button>
  </div>

  <div id="statusLine" class="small" style="margin-top:8px"></div>
</div>

<div class="card" id="programArea"></div>

<div class="card">
  <pre id="logArea" class="small"></pre>
</div>

<!-- SCRIPT ORDER (critical) -->
<script src="trainingKnowledge.js"></script>
<script src="equipmentEngine.js"></script>
<script src="biomechanicalEngine.js"></script>
<script src="studyEngine.js"></script>
<script src="sessionengine1.js"></script>

<script>
let exerciseDB = null;
let currentSession = null;

// load JSON DB
async function loadDB(){
  try {
    const res = await fetch("exercises.json",{cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    exerciseDB = await res.json();
    document.getElementById("statusLine").innerText = "DB caricato ✔";
  } catch(e) {
    document.getElementById("statusLine").innerText = "Errore DB ❌";
    console.error("Errore fetch exercises.json:",e);
  }
}

function today(){
  return new Date().toISOString().split("T")[0];
}

function genSession(){
  if(!exerciseDB){
    alert("DB non caricato!");
    return;
  }
  if(typeof SessionEngine !== "object"){
    alert("SessionEngine non trovato");
    return;
  }

  const mode = parseInt(document.getElementById("mode").value,10);

  currentSession = SessionEngine.generateSession(exerciseDB,{
    sessionMinutes: mode,
    runDay:false,
    fasting:false
  });

  renderSession();
  document.getElementById("statusLine").innerText =
    "Sessione generata: "+today()+" • "+mode+" min";
}

function renderSession(){
  const area=document.getElementById("programArea");
  area.innerHTML="";

  if(!currentSession)return;

  renderBlock("Riscaldamento",currentSession.warm,area);
  renderBlock("Mobilità",currentSession.mobility,area);
  renderBlock("Forza",currentSession.strength,area);
}

function renderBlock(title,list,container){
  if(!Array.isArray(list) || list.length===0) return;
  container.innerHTML += `<div class="sectionTitle">${title} (${list.length})</div>`;

  list.forEach((ex,i)=>{
    container.innerHTML += renderExercise(ex,i);
  });
}

function renderExercise(ex){
  const cues = [
    ...(typeof BiomechanicalEngine==="object" && BiomechanicalEngine.getCues ? BiomechanicalEngine.getCues(ex):[]),
    ...(typeof StudyEngine==="object" && StudyEngine.getCues ? StudyEngine.getCues(ex):[]),
    ...(ex.cues || [])
  ];

  const uniques = [...new Set(cues)];

  let html=`<div class="exercise"><b>${ex.name}</b>`;

  if(ex.prescription){
    html += `<div>Rx: ${ex.prescription.cycles}× ${ex.prescription.reps}</div>`;
    if(ex.prescription.band)
      html += `<div>Banda: ${ex.prescription.band}</div>`;
  }

  if(uniques.length){
    html += `<div class="cues">• ${uniques.join("<br>• ")}</div>`;
  }

  html += "</div>";
  return html;
}

function completeSession(){
  if(!currentSession){
    alert("Genera una sessione prima!");
    return;
  }

  const rpe=parseInt(document.getElementById("rpe").value,10);

  const payload={
    date: today(),
    rpe: rpe,
    mode: document.getElementById("mode").value,
    session: currentSession
  };

  console.log("complete payload:",payload);

  try{
    if(typeof StudyEngine==="object" && StudyEngine.completeSession)
      StudyEngine.completeSession(payload);
  }catch(e){console.warn(e)}

  try{
    if(typeof BiomechanicalEngine==="object" && BiomechanicalEngine.completeSession)
      BiomechanicalEngine.completeSession(payload);
  }catch(e){console.warn(e)}

  try{
    if(typeof SessionEngine==="object" && SessionEngine.completeSession)
      SessionEngine.completeSession(payload);
  }catch(e){console.warn(e)}

  document.getElementById("logArea").innerText =
    JSON.stringify(payload,null,2);
  document.getElementById("statusLine").innerText =
    "Allenamento completato ✔";
}

// events
document.getElementById("btnGen").addEventListener("click",genSession);
document.getElementById("btnComplete").addEventListener("click",completeSession);

// load DB on start
loadDB();
</script>

</body>
</html>
