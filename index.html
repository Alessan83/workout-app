<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Workout 100</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{font-family:Arial;background:#111;color:#eee;padding:15px;text-align:center}
  button{padding:8px;margin:6px;background:#222;color:#eee;border:1px solid #444}
  select{background:#222;color:#eee;border:1px solid #444;padding:5px}
  .section{margin:14px 0;font-weight:bold}
  .exercise{border:1px solid #333;padding:10px;margin:7px 0;text-align:left}
  a{color:#4da6ff;text-decoration:none}
  .small{font-size:12px;color:#aaa}
  .pill{display:inline-block;border:1px solid #333;padding:4px 8px;margin:4px;background:#151515}
  .square{width:14px;height:14px;border:1px solid #444;display:inline-block;margin-right:6px;vertical-align:middle}
  .done{background:#2a7a2a}
  hr{border:0;border-top:1px solid #333;margin:12px 0}
</style>
</head>
<body>

<h2>Workout 100</h2>

<div class="pill">Allenamento: <span id="workoutType"></span></div>

<div class="pill">
  <select id="mode">
    <option value="25">25 minuti</option>
    <option value="35">35 minuti</option>
  </select>
</div>

<div style="margin-top:6px">
  <span id="doneSquare" class="square"></span>
  <span class="pill">Streak: <span id="streak">0</span></span>
  <span class="pill">Oggi: <span id="todayStr">—</span></span>
</div>

<hr>

<div id="program"></div>

<hr>

<div>
  <div class="pill">Fase: <b id="phase">—</b></div>
  <div class="pill">Tempo: <b id="timeLeft">—</b></div>
</div>

<div style="margin-top:10px">
  <button onclick="startSession()">Start Sessione</button>
  <button onclick="nextPhase()">Fase Successiva</button>
</div>

<div style="margin-top:10px">
  <button onclick="completeWorkout()">Allenamento completato</button>
</div>

<script>
/* =========================================================
   OBIETTIVO
   - Tutto il corpo, priorità parte superiore
   - Lower: stabilizzazione (posterior chain + caviglie) NON volume gambe
   - Random stabile per oggi + anti-ripetizione
   - Pattern blocchi random AB o ABC (stabile per oggi/categoria)
   - Timer a fasi (percentuali) + metronomo (solo warm + 30s relax)
   - Salvataggio SOLO su "Allenamento completato"
========================================================= */

/* ===========================
   STORAGE
=========================== */
const STORE="workoutV7";
let data=JSON.parse(localStorage.getItem(STORE))||{
  lastDate:null,
  lastWorkout:0,
  completedDate:null,
  streak:0,
  categories:{
    pull:{band:0,reps:12},
    push:{band:0,reps:12},
    posterior:{band:1,reps:12} // leggermente più “stabile”/resistente
  }
};

function save(){localStorage.setItem(STORE,JSON.stringify(data));}
function today(){return new Date().toISOString().split("T")[0];}
document.getElementById("todayStr").innerText=today();

/* ===========================
   ROTAZIONE 1-2-3 (stabile per giorno)
=========================== */
const workouts={
  // priorità upper: pull & push sempre, posterior è stabilizzazione
  1:["pull","push","posterior"],      // bilanciato
  2:["pull","push","posterior"],      // stesso ordine: cambia pattern+esercizi, focus upper
  3:["pull","push","posterior"]       // stesso: stabilità -> meno caos, più aderenza
};

function generateWorkout(){
  if(data.lastDate!==today()){
    data.lastWorkout=(data.lastWorkout%3)+1;
    data.lastDate=today();
    save();
  }
  document.getElementById("workoutType").innerText=data.lastWorkout;
  renderStatus();
  renderProgram();
}

/* ===========================
   STATUS
=========================== */
function renderStatus(){
  document.getElementById("streak").innerText=data.streak;
  const sq=document.getElementById("doneSquare");
  if(data.completedDate===today()) sq.classList.add("done");
  else sq.classList.remove("done");
}

/* ===========================
   DATABASE ESERCIZI (full-body con priorità upper + stabilizzazione)
   - warm: 3
   - mobility: 2
   - coreMobility: 2 (stabilità)
   - blocchi: pull/push/posterior (pattern AB o ABC)
   - core: 1
   - stretch: 1
=========================== */
const exerciseDB={
  warm:[
    "Jumping Jacks","High Knees","Butt Kicks","Shadow Boxing",
    "Inchworm","Squat to Stand","Arm Circles","Scapular Push-up",
    "Ankle Bounces","Side Shuffle"
  ],
  mobility:[
    "Thoracic Rotation (quadruped)","Open Book","Thread the Needle","Cat-Cow",
    "Hip CARs","90/90 Hip Switch","Deep Squat Hold (light)","Ankle Rock (knee to wall)",
    "Wall Slides","Shoulder CARs"
  ],
  // core stabilità in mobilità: anti-rotazione / anti-estensione / controllo bacino
  coreMobility:[
    "Dead Bug (slow)","Bird Dog (slow)","Pallof Press (band)",
    "Bear Hover (10-20s)","Side Plank Reach","Hollow Hold (short)",
    "Glute Bridge Hold","Marching Glute Bridge (slow)"
  ],
  core:[
    "Plank","Side Plank","Dead Bug","Pallof Press (band)","Hollow Hold","Bear Hold"
  ],
  stretch:[
    "Child Pose","Hip Flexor Stretch","Hamstring Stretch","Pec Stretch (doorway)",
    "Lat Stretch","Calf Stretch"
  ],

  // UPPER PULL (bande + bodyweight)
  pull:[
    "Band Row","Band High Row","Band Face Pull","Band Pull-Apart",
    "Band Reverse Fly","Band Lat Pulldown (door anchor)","Band Curl",
    "Isometric Row Hold (band)","Prone Y-T-W","Scapular Retraction (band)"
  ],

  // UPPER PUSH
  push:[
    "Push-up","Incline Push-up","Diamond Push-up","Pike Push-up",
    "Band Floor Press","Band Overhead Press","Band Triceps Extension",
    "Close-Grip Push-up","Hand-Release Push-up","Shoulder External Rotation (band)"
  ],

  // POSTERIOR / LOWER STABILIZATION (no “quad pump”, focus hinge/caviglia/gluteo)
  posterior:[
    "Banded RDL","Banded Deadlift","Good Morning (band)",
    "Glute Bridge (band)","Single-Leg RDL (band/light)",
    "Hamstring Walkout","Calf Raise (slow)","Single-Leg Calf Raise",
    "Tibialis Raise","Monster Walk (miniloop)"
  ]
};

function tutorialLink(name){
  return "https://www.youtube.com/results?search_query="+encodeURIComponent(name+" exercise tutorial");
}

/* ===========================
   PATCH 1 — Random stabile + anti-ripetizione (ultimi 12 per categoria)
=========================== */
function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296;}}
function seedFromDate(str){let n=0;for(let i=0;i<str.length;i++)n=(n*31+str.charCodeAt(i))>>>0;return n;}
function getHistoryKey(cat){return "hist_"+cat;}

function pickExercises(cat,count){
  const rng = mulberry32(seedFromDate(today()+":"+cat));
  const list = (exerciseDB[cat]||[]).slice();

  const histKey = getHistoryKey(cat);
  const hist = JSON.parse(localStorage.getItem(histKey) || "[]");

  let pool = list.filter(x=>!hist.includes(x));
  if(pool.length < count) pool = list;

  for(let i=pool.length-1;i>0;i--){
    const j=Math.floor(rng()*(i+1));
    [pool[i],pool[j]]=[pool[j],pool[i]];
  }

  const picked = pool.slice(0,count);
  const newHist = [...picked,...hist].slice(0,12);
  localStorage.setItem(histKey, JSON.stringify(newHist));
  return picked;
}

/* ===========================
   Pattern blocco (stabile per oggi/categoria):
   - AB: 2 esercizi -> alternanza ciclica ABAB...
   - ABC: 3 esercizi -> giro A->B->C...
=========================== */
function pickPatternFor(cat){
  const rng = mulberry32(seedFromDate(today()+":pattern:"+cat));
  return (rng() < 0.55) ? "AB" : "ABC"; // leggermente più AB (più semplice/eseguibile)
}

/* ===========================
   UI CONTROLLI: banda/reps/RPE 3 livelli
=========================== */
const bands=[15,25,35];
const repOpts=[8,10,12,14,16,18,20];

function strengthRowHTML(cat,i,suggestedBand,suggestedReps){
  return `
    <div class="small" style="margin-top:6px">
      Banda:
      <select id="${cat}_band_${i}">
        <option value="0"${suggestedBand===15?' selected':''}>15kg</option>
        <option value="1"${suggestedBand===25?' selected':''}>25kg</option>
        <option value="2"${suggestedBand===35?' selected':''}>35kg</option>
      </select>
      Reps:
      <select id="${cat}_reps_${i}">
        ${repOpts.map(r=>`<option${r===suggestedReps?' selected':''}>${r}</option>`).join("")}
      </select>
      RPE:
      <select id="${cat}_rpe_${i}">
        <option value="1">Facile</option>
        <option value="2" selected>Medio</option>
        <option value="3">Duro</option>
      </select>
    </div>
    <div class="small">Target: ${suggestedBand}kg / ${suggestedReps} reps</div>
  `;
}

function exerciseHTML(name){
  return `<div class="exercise">
    <b>${name}</b>
    <div class="small"><a href="${tutorialLink(name)}" target="_blank">Apri tutorial</a></div>
  </div>`;
}

function strengthExerciseHTML(name,cat,i){
  const suggestedBand=bands[data.categories[cat].band] || 15;
  const suggestedReps=data.categories[cat].reps || 12;
  return `<div class="exercise">
    <b>${name}</b>
    ${strengthRowHTML(cat,i,suggestedBand,suggestedReps)}
    <div class="small"><a href="${tutorialLink(name)}" target="_blank">Apri tutorial</a></div>
  </div>`;
}

/* ===========================
   RENDER PROGRAMMA (full-body, upper priority, stabilizzazione)
=========================== */
function renderProgram(){
  const container=document.getElementById("program");
  container.innerHTML="";

  const warm = pickExercises("warm",3);
  const mobility = pickExercises("mobility",2);
  const coreMob = pickExercises("coreMobility",2);
  const core = pickExercises("core",1);
  const stretch = pickExercises("stretch",1);

  container.innerHTML+=`<div class="section">Riscaldamento (3)</div>`;
  warm.forEach(e=>container.innerHTML+=exerciseHTML(e));

  container.innerHTML+=`<div class="section">Mobilità (2)</div>`;
  mobility.forEach(e=>container.innerHTML+=exerciseHTML(e));

  container.innerHTML+=`<div class="section">Core Stability (mobilità) (2)</div>`;
  coreMob.forEach(e=>container.innerHTML+=exerciseHTML(e));

  // blocchi: sempre pull + push + posterior, priorità upper
  const cats = workouts[data.lastWorkout];
  cats.forEach(cat=>{
    const pattern = pickPatternFor(cat); // AB o ABC
    const count = (pattern==="AB") ? 2 : 3;

    container.innerHTML+=`<div class="section">${cat.toUpperCase()} (${count})</div>`;
    container.innerHTML+=`<div class="small">Pattern blocco: <b>${pattern}</b> — alterna gli esercizi (ABAB...) o giro (ABC...).</div>`;

    const list = pickExercises(cat,count);
    list.forEach((e,i)=>container.innerHTML+=strengthExerciseHTML(e,cat,i));
  });

  container.innerHTML+=`<div class="section">Core / Controllo (1)</div>`;
  core.forEach(e=>container.innerHTML+=exerciseHTML(e));

  container.innerHTML+=`<div class="section">Stretch / Rilassamento (1)</div>`;
  stretch.forEach(e=>container.innerHTML+=exerciseHTML(e));
}

/* ===========================
   TIMER + METRONOMO
   - Percentuali: warm 3%, mobility 2%, esercizi 94% (3 blocchi), core 2%, stretch 3%
   - Metronomo: SOLO in warm + 30s rilassamento
   - Pausa: solo tra blocchi (30s)
   - Cambio esercizio: manuale (tu lo fai), qui cambia solo la fase
=========================== */
let phases=[];
let current=0;
let timer=null;

let audioCtx=null;
let gainNode=null;

function initAudio(){
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  gainNode=audioCtx.createGain();
  gainNode.gain.value=0.01; // bassissimo
  gainNode.connect(audioCtx.destination);
}

function beep(){
  if(!audioCtx) initAudio();
  const osc=audioCtx.createOscillator();
  osc.type="sine";
  osc.frequency.value=520;
  osc.connect(gainNode);
  osc.start();
  osc.stop(audioCtx.currentTime+0.04);
}

function buildPhases(){
  const total = parseInt(document.getElementById("mode").value,10)*60;

  let warmT = Math.round(total*0.03);
  let mobT  = Math.round(total*0.02);
  let coreT = Math.round(total*0.02);
  let stretchT = Math.round(total*0.03);

  // rilassamento beep fisso 30s
  stretchT = Math.max(stretchT, 30);

  // esercizi = resto
  let exT = total - (warmT + mobT + coreT + stretchT);
  exT = Math.max(exT, 60);

  const block = Math.floor(exT/3);

  phases = [
    {name:"Riscaldamento (metronomo 2–1–2)", time:warmT, metronome:true},
    {name:"Mobilità", time:mobT, metronome:false},
    {name:"Blocco 1 (Upper)", time:block, metronome:false},
    {name:"Pausa", time:30, metronome:false},
    {name:"Blocco 2 (Upper)", time:block, metronome:false},
    {name:"Pausa", time:30, metronome:false},
    {name:"Blocco 3 (Stabilizzazione)", time:block, metronome:false},
    {name:"Core / Controllo", time:coreT, metronome:false},
    {name:"Rilassamento 30s (metronomo)", time:30, metronome:true},
  ];
  // eventuale stretch residuo senza beep
  const residual = stretchT - 30;
  if(residual > 0) phases.push({name:"Stretch (senza metronomo)", time:residual, metronome:false});
}

function startSession(){
  buildPhases();
  current=0;
  runPhase();
}

function runPhase(){
  if(timer){clearInterval(timer); timer=null;}
  if(current>=phases.length){
    document.getElementById("phase").innerText="Sessione finita";
    document.getElementById("timeLeft").innerText="—";
    return;
  }
  const phase=phases[current];
  let t=phase.time;

  document.getElementById("phase").innerText=phase.name;
  document.getElementById("timeLeft").innerText=t+" sec";

  timer=setInterval(()=>{
    t--;
    document.getElementById("timeLeft").innerText=t+" sec";
    if(phase.metronome) beep();
    if(t<=0){
      clearInterval(timer);
      timer=null;
      current++;
      runPhase();
    }
  },1000);
}

function nextPhase(){
  if(timer){clearInterval(timer); timer=null;}
  current++;
  runPhase();
}

/* ===========================
   PROGRESSIONE (priorità upper, posterior più conservativa)
   - Solo se completato oggi (manuale)
   - Input per categoria: media reps + RPE dei 2/3 esercizi del blocco
   - Regole:
     * RPE Facile (1) e reps >= target+4 -> target +2 (max 20)
     * se target==20 e RPE Facile -> banda +1 (max 35) e reset reps 12
     * RPE Duro (3) e reps < target -> target -2 (min 8)
=========================== */
function completeWorkout(){
  if(data.completedDate===today()){
    alert("Già completato oggi.");
    return;
  }

  // streak coerente (solo consecutivi)
  if(data.completedDate){
    const prev=new Date(data.completedDate+"T00:00:00");
    const cur=new Date(today()+"T00:00:00");
    const diffDays=Math.round((cur-prev)/(1000*60*60*24));
    data.streak = (diffDays===1) ? (data.streak+1) : 1;
  }else{
    data.streak=1;
  }
  data.completedDate=today();

  const cats = workouts[data.lastWorkout];

  cats.forEach(cat=>{
    // quante righe ci sono (AB=2, ABC=3) -> leggiamo fino a che esistono
    let repsSum=0, rpeSum=0, n=0;

    for(let i=0;i<3;i++){
      const repsEl=document.getElementById(`${cat}_reps_${i}`);
      const rpeEl=document.getElementById(`${cat}_rpe_${i}`);
      if(!repsEl || !rpeEl) continue;

      const reps=parseInt(repsEl.value,10);
      const rpe=parseInt(rpeEl.value,10);
      repsSum+=reps; rpeSum+=rpe; n++;
    }
    if(n===0) return;

    const avgReps=Math.round(repsSum/n);
    const avgRpe=Math.round(rpeSum/n);

    const st=data.categories[cat];
    let target=st.reps;
    let bandIdx=st.band;

    if(avgRpe<=1 && avgReps>=target+4){
      if(target<20){
        target=Math.min(20,target+2);
      }else{
        if(bandIdx<2){
          bandIdx=bandIdx+1; // 15->25->35
          target=12;
        }
      }
    }else if(avgRpe>=3 && avgReps<target){
      target=Math.max(8,target-2);
    }

    // posterior: più conservativa (stabilizzazione)
    if(cat==="posterior"){
      // limita gli aumenti troppo rapidi
      target = Math.min(target, 18);
    }

    st.reps=target;
    st.band=bandIdx;
  });

  save();
  renderStatus();
  renderProgram();
  alert("Allenamento salvato. Progressione aggiornata.");
}

/* ===========================
   INIT
=========================== */
generateWorkout();

</script>
</body>
</html>
