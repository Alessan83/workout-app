<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Workout 100 (offline)</title>
<style>
/* --- STILE ORIGINALE INVARIATO --- */
:root{
--bg:#0f1115; --panel:#151924; --text:#e8e8e8; --muted:#a8b0c0; --line:#2a3142;
--accent:#4da6ff; --ok:#25d366; --warn:#f5c542; --danger:#ff5c5c;
}
<script src="studyEngine.js"></script>   
body{font-family:Arial,system-ui;background:var(--bg);color:var(--text);margin:0;padding:14px;}
.card{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:10px;margin:10px auto;max-width:980px;}
.exercise{border:1px solid var(--line);border-radius:10px;padding:10px;margin:8px 0;background:#0b0d12;}
button{cursor:pointer}
.logBox{white-space:pre-wrap}
</style>
</head>
<body>

<h1>Workout 100</h1>

<div class="card">
Durata:
<select id="mode">
<option value="25">25 minuti</option>
<option value="35">35 minuti</option>
</select>

RPE:
<select id="rpeGlobal">
<option value="1">1 = facile</option>
<option value="2" selected>2 = ok</option>
<option value="3">3 = duro</option>
</select>

<button id="regenBtn">Rigenera (oggi)</button>
<button id="completeBtn">Allenamento completato</button>
</div>

<div class="card">
<div id="program"></div>
</div>

<div class="card">
<div class="logBox" id="logBox"></div>
</div>

<script>

/* ==========================
   DB
========================== */

let exerciseDB=null;
async function loadDB(){
  try{
    const res = await fetch("exercises.json",{cache:"no-store"});

    if(!res.ok){
      throw new Error("HTTP "+res.status);
    }

    exerciseDB = await res.json();
    boot();

  }catch(e){
    console.error("Errore fetch:", e);
    document.getElementById("program").innerHTML =
      "<b>Errore caricamento exercises.json</b><br>"+e;
  }
{
try{
const res=await fetch("exercises.json",{cache:"no-store"});
exerciseDB=await res.json();
boot();
}catch(e){
document.getElementById("program").innerHTML="Errore caricamento exercises.json";
}
}

/* ==========================
   STORAGE
========================== */

const STORAGE_KEY="workout100_v9";

const DEFAULT_DATA={
startDate:new Date().toISOString().split("T")[0],
lastGeneratedKey:null,
dayPicks:null,
completedDate:null,
streak:0,
prog:{upper:{band:15,repIndex:2},core:{band:15,repIndex:1},lower:{band:15,repIndex:1}},
history:{},
sessions:[]
};

function loadData(){
try{
const raw=localStorage.getItem(STORAGE_KEY);
if(!raw) return structuredClone(DEFAULT_DATA);
const parsed=JSON.parse(raw);
return {...structuredClone(DEFAULT_DATA),...parsed};
}catch{
return structuredClone(DEFAULT_DATA);
}
}

function saveData(){
localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
}

let data=loadData();

/* ==========================
   UTILS
========================== */

const REPS_OPTIONS=[8,10,12,14,16,18,20];
const BANDS=[15,25,35];
const TEMPO="2-1-2";

function clamp(n,min,max){return Math.max(min,Math.min(max,n));}
function today(){return new Date().toISOString().split("T")[0];}
function daysBetween(d1,d2){return Math.floor((new Date(d2)-new Date(d1))/86400000);}

/* ==========================
   WORKOUT ENGINE
========================== */

const WorkoutEngine={

getSuggested(data,family,mode){

const phase=Math.floor(daysBetween(data.startDate,today())/7)%4;
const p=data.prog[family]||{band:15,repIndex:2};

let repIndex=p.repIndex;
let band=p.band;

if(mode==="35") repIndex++;
if(phase===1) repIndex++;
if(phase===3) repIndex--;

repIndex=clamp(repIndex,0,REPS_OPTIONS.length-1);

return{
band,
reps:REPS_OPTIONS[repIndex],
repIndex
};

},

applyProgression(data,family,repsDone,repsTarget,rpe){

let p=data.prog[family]||{band:15,repIndex:2};
let bi=BANDS.indexOf(p.band);
if(bi<0) bi=0;

if(rpe===1 && repsDone>=repsTarget){
if(p.repIndex<REPS_OPTIONS.length-1){
p.repIndex++;
}else if(bi<BANDS.length-1){
bi++;
p.band=BANDS[bi];
p.repIndex=1;
}
}

if(rpe===3 && repsDone<repsTarget){
if(p.repIndex>0){
p.repIndex--;
}else if(bi>0){
bi--;
p.band=BANDS[bi];
p.repIndex=1;
}
}

data.prog[family]=p;

}

};

/* ==========================
   BUILD PROGRAM
========================== */

let picks=null;

function buildProgram(){

const mode=document.getElementById("mode").value;

picks=exerciseDB.training||[];

renderProgram();

}

function renderProgram(){

const analysis = StudyEngine.analyzeExercise(ex);

container.innerHTML += `
<div class="exercise">
  <b>${ex.name}</b><br>
  Pattern: ${analysis.pattern}<br>
  Carico rachide: ${analysis.spinalLoad}<br>
  Evidenza: ${analysis.evidenceTag}
</div>
`;
const mode=document.getElementById("mode").value;
const container=document.getElementById("program");
container.innerHTML="";

picks.forEach(ex=>{

const fam=ex.family||"core";
const sug=WorkoutEngine.getSuggested(data,fam,mode);

container.innerHTML+=`
<div class="exercise">
<b>${ex.name}</b><br>
Banda: ${sug.band} kg<br>
Target reps: ${sug.reps}<br>
<select class="didReps">
${REPS_OPTIONS.map(r=>`<option ${r===sug.reps?"selected":""}>${r}</option>`).join("")}
</select>
</div>
`;

});

}

/* ==========================
   COMPLETE
========================== */

function completeWorkout(){

const mode=document.getElementById("mode").value;
const rpe=parseInt(document.getElementById("rpeGlobal").value,10);

const exEls=document.querySelectorAll(".exercise");

exEls.forEach((el,i)=>{

const repsDone=parseInt(el.querySelector(".didReps").value,10);
const ex=picks[i];
const fam=ex.family||"core";
const sug=WorkoutEngine.getSuggested(data,fam,mode);

WorkoutEngine.applyProgression(data,fam,repsDone,sug.reps,rpe);

});

data.sessions.push({date:today(),mode});
saveData();
updateLog();

alert("Allenamento salvato.");

}

/* ==========================
   LOG
========================== */

function updateLog(){
document.getElementById("logBox").innerText=
JSON.stringify(data.prog,null,2);
}

/* ==========================
   EVENTS
========================== */

document.getElementById("regenBtn").addEventListener("click",buildProgram);
document.getElementById("completeBtn").addEventListener("click",completeWorkout);

/* ==========================
   BOOT
========================== */

function boot(){
buildProgram();
updateLog();
}

loadDB();

</script>
</body>
</html>
