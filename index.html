<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Workout 100</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#111;color:#eee;padding:15px;text-align:center}
button{padding:8px;margin:6px;background:#222;color:#eee;border:1px solid #444;border-radius:8px}
select{background:#222;color:#eee;border:1px solid #444;padding:6px;border-radius:8px}
.section{margin:15px 0}
.exercise{border:1px solid #333;padding:10px;margin:8px 0;border-radius:10px;text-align:left}
.exercise b{display:block;margin-bottom:4px}
a{color:#4da6ff;text-decoration:none}
small{color:#aaa}
.pill{display:inline-block;padding:2px 8px;border:1px solid #444;border-radius:999px;margin:4px 6px 0 0;font-size:12px}
</style>
</head>
<body>

<h2>Workout 100</h2>

<div>
Allenamento: <span id="workoutType"></span>
</div>

<div style="margin-top:10px">
<select id="mode" onchange="renderProgram();renderStatus();">
  <option value="25">25 minuti</option>
  <option value="35">35 minuti</option>
</select>
</div>

<div id="status" style="margin-top:10px"></div>

<div id="program" style="margin-top:10px"></div>

<div class="section">
  <div id="phase" style="font-weight:bold"></div>
  <div id="timeLeft"></div>
  <button onclick="startPhase()">Start Fase</button>
  <button onclick="nextPhase()">Fase Successiva</button>
</div>

<button onclick="completeWorkout()">Allenamento completato</button>

<script>
// =====================================================
// STORAGE / STATO
// =====================================================

const STORAGE_KEY = "workoutV5";

let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
  startDate: new Date().toISOString().split("T")[0],
  lastDate: null,
  lastWorkout: 0,
  streak: 0,
  completedDate: null,
  categories: {
    pull: { bandLevel: 1, time: 40, streak: 0 },       // 0=Verde,1=Giallo,2=Arancio
    push: { bandLevel: 1, time: 40, streak: 0 },
    posterior: { bandLevel: 1, time: 40, streak: 0 }
  }
};

const BAND_COLORS = ["Verde (leggero)", "Giallo (medio)", "Arancio (alto)"];

// Rotazione giornaliera delle categorie
const workouts = {
  1: ["pull","push","posterior"],
  2: ["push","posterior","pull"],
  3: ["posterior","pull","push"]
};

// =====================================================
// DATABASE ESERCIZI (con link diretto)
// NOTE IMPORTANTI:
// - Esercizi con banda: nessun punto di ancoraggio esterno (solo corpo + banda)
// - Corpo libero: punti dâ€™appoggio solo il corpo
// =====================================================

const exerciseDB = {

  // MOBILITÃ€ (prima)
  mobility: [
    {name:"Hip CARs", reps:"6 per lato", note:"lento, controllo totale", link:"https://www.youtube.com/results?search_query=Hip+CARs+mobility"},
    {name:"90/90 Hip Switch", reps:"8 per lato", note:"senza slancio", link:"https://www.youtube.com/results?search_query=90+90+hip+switch"},
    {name:"Thoracic Rotation (Quadrupedia)", reps:"8 per lato", note:"espira in rotazione", link:"https://www.youtube.com/results?search_query=thoracic+rotation+quadruped"},
    {name:"Open Book", reps:"8 per lato", note:"movimento ampio", link:"https://www.youtube.com/results?search_query=open+book+thoracic+mobility"},
    {name:"Ankle Rock / Knee to Wall", reps:"10 per lato", note:"tallone giÃ¹", link:"https://www.youtube.com/results?search_query=knee+to+wall+ankle+mobility"},
    {name:"Cat-Cow", reps:"8-10", note:"segmenta la colonna", link:"https://www.youtube.com/results?search_query=cat+cow+exercise"},
    {name:"Worldâ€™s Greatest Stretch", reps:"4 per lato", note:"pausa 2 sec", link:"https://www.youtube.com/results?search_query=worlds+greatest+stretch"},
    {name:"Shoulder CARs", reps:"5 per lato", note:"scapola controllata", link:"https://www.youtube.com/results?search_query=shoulder+CARs"}
  ],

  // RISCALDAMENTO (dopo)
  warm: [
    {name:"Jumping Jacks", reps:"40 sec", note:"ritmo costante", link:"https://www.youtube.com/results?search_query=jumping+jacks+proper+form"},
    {name:"High Knees", reps:"30 sec", note:"intensitÃ  moderata", link:"https://www.youtube.com/results?search_query=high+knees+exercise"},
    {name:"Butt Kicks", reps:"30 sec", note:"cadenza regolare", link:"https://www.youtube.com/results?search_query=butt+kicks+exercise"},
    {name:"Mountain Climbers (lenti)", reps:"30 sec", note:"spalle stabili", link:"https://www.youtube.com/results?search_query=slow+mountain+climbers"},
    {name:"Inchworm", reps:"5-6", note:"attiva core + posterior chain", link:"https://www.youtube.com/results?search_query=inchworm+exercise"},
    {name:"Squat to Stand", reps:"6-8", note:"apri anche + caviglie", link:"https://www.youtube.com/results?search_query=squat+to+stand+mobility"},
    {name:"Arm Circles", reps:"20 avanti + 20 indietro", note:"ampiezza progressiva", link:"https://www.youtube.com/results?search_query=arm+circles+exercise"}
  ],

  // CORE
  core: [
    {name:"Plank", reps:"30 sec", note:"glutei attivi, addome forte", link:"https://www.youtube.com/results?search_query=plank+proper+form"},
    {name:"Dead Bug", reps:"10 per lato", note:"lombare neutra", link:"https://www.youtube.com/results?search_query=dead+bug+exercise"},
    {name:"Side Plank", reps:"20 sec per lato", note:"allineamento", link:"https://www.youtube.com/results?search_query=side+plank+proper+form"},
    {name:"Hollow Hold (base)", reps:"15-25 sec", note:"schiena a terra", link:"https://www.youtube.com/results?search_query=hollow+hold+exercise"},
    {name:"Pallof Press (banda)", reps:"10 per lato", note:"banda attorno schiena o sotto piedi (no ancoraggio esterno)", band:true, link:"https://www.youtube.com/results?search_query=pallof+press+resistance+band+no+anchor"}
  ],

  // STRETCH (fine sessione)
  stretch: [
    {name:"Child Pose", reps:"40 sec", note:"respira lento", link:"https://www.youtube.com/results?search_query=child+pose+stretch"},
    {name:"Hamstring Stretch", reps:"30 sec per lato", note:"senza molleggio", link:"https://www.youtube.com/results?search_query=hamstring+stretch"},
    {name:"Hip Flexor Stretch", reps:"30 sec per lato", note:"bacino in retroversione", link:"https://www.youtube.com/results?search_query=hip+flexor+stretch"},
    {name:"Chest Opener (doorway senza porta)", reps:"30 sec", note:"mani dietro schiena, apri petto", link:"https://www.youtube.com/results?search_query=chest+stretch+hands+behind+back"}
  ],

  // PULL (schiena/bicipiti) â€” con banda senza ancoraggi
  pull: [
    {name:"Band Row (banda sotto piedi)", reps:"12", note:"gomiti vicino al corpo", band:true, link:"https://www.youtube.com/results?search_query=resistance+band+row+under+feet"},
    {name:"Single-Arm Band Row (banda sotto piede)", reps:"10 per lato", note:"stabile, no torsioni", band:true, link:"https://www.youtube.com/results?search_query=single+arm+band+row+under+foot"},
    {name:"Face Pull (banda attorno schiena)", reps:"12", note:"gomiti larghi, scapole", band:true, link:"https://www.youtube.com/results?search_query=band+face+pull+no+anchor"},
    {name:"Band Pull Apart", reps:"15", note:"spalle basse", band:true, link:"https://www.youtube.com/results?search_query=band+pull+apart+exercise"},
    {name:"Reverse Fly (banda)", reps:"12", note:"controlla la chiusura", band:true, link:"https://www.youtube.com/results?search_query=band+reverse+fly+exercise"},
    {name:"Banded Curl (banda sotto piedi)", reps:"12", note:"gomiti fermi", band:true, link:"https://www.youtube.com/results?search_query=resistance+band+bicep+curl+under+feet"}
  ],

  // PUSH (petto/spalle/tricipiti)
  push: [
    {name:"Push-up", reps:"10-15", note:"core forte, linea unica", link:"https://www.youtube.com/results?search_query=push+up+proper+form"},
    {name:"Incline Push-up (mani su divano)", reps:"12-18", note:"riduci carico", link:"https://www.youtube.com/results?search_query=incline+push+up"},
    {name:"Pike Push-up", reps:"6-10", note:"spalle, testa tra braccia", link:"https://www.youtube.com/results?search_query=pike+push+up+exercise"},
    {name:"Diamond Push-up", reps:"6-12", note:"tricipiti", link:"https://www.youtube.com/results?search_query=diamond+push+up"},
    {name:"Band Floor Press (banda attorno schiena)", reps:"12", note:"spingi controllato", band:true, link:"https://www.youtube.com/results?search_query=band+floor+press+no+anchor"},
    {name:"Band Overhead Press (banda sotto piedi)", reps:"10-12", note:"glutei attivi", band:true, link:"https://www.youtube.com/results?search_query=band+overhead+press+under+feet"},
    {name:"Band Triceps Extension (banda sotto piedi)", reps:"12", note:"gomiti fermi", band:true, link:"https://www.youtube.com/results?search_query=band+triceps+extension+under+feet"}
  ],

  // POSTERIOR (catena posteriore)
  posterior: [
    {name:"Glute Bridge", reps:"15", note:"pausa 1 sec in alto", link:"https://www.youtube.com/results?search_query=glute+bridge+proper+form"},
    {name:"Single-Leg Glute Bridge", reps:"10 per lato", note:"bacino stabile", link:"https://www.youtube.com/results?search_query=single+leg+glute+bridge"},
    {name:"Good Morning (banda sotto piedi)", reps:"12", note:"anca indietro, schiena neutra", band:true, link:"https://www.youtube.com/results?search_query=band+good+morning+under+feet"},
    {name:"Banded RDL (banda sotto piedi)", reps:"10-12", note:"tensione continua", band:true, link:"https://www.youtube.com/results?search_query=band+romanian+deadlift+under+feet"},
    {name:"Bodyweight RDL", reps:"12", note:"hinge puro", link:"https://www.youtube.com/results?search_query=bodyweight+RDL+hinge"},
    {name:"Hamstring Walkout", reps:"8-10", note:"lento, controllo", link:"https://www.youtube.com/results?search_query=hamstring+walkout"}
  ]
};

// =====================================================
// RANDOM â€œSTABILE PER OGGIâ€ + ANTI-RIPETIZIONE
// =====================================================

function today(){ return new Date().toISOString().split("T")[0]; }

function mulberry32(a){
  return function(){
    var t=a+=0x6D2B79F5;
    t=Math.imul(t^t>>>15,t|1);
    t^=t+Math.imul(t^t>>>7,t|61);
    return ((t^t>>>14)>>>0)/4294967296;
  }
}
function seedFromString(str){
  let n=0;
  for(let i=0;i<str.length;i++) n=(n*31 + str.charCodeAt(i))>>>0;
  return n;
}
function histKey(cat){ return "hist_"+cat; }

function pickExercises(cat, count){
  const rng = mulberry32(seedFromString(today()+":"+cat));
  const list = (exerciseDB[cat] || []).slice();

  const hist = JSON.parse(localStorage.getItem(histKey(cat)) || "[]");

  let pool = list.filter(ex => !hist.includes(ex.name));
  if(pool.length < count) pool = list;

  for(let i=pool.length-1;i>0;i--){
    const j = Math.floor(rng()*(i+1));
    [pool[i],pool[j]]=[pool[j],pool[i]];
  }

  const picked = pool.slice(0,count);
  const newHist = [...picked.map(x=>x.name), ...hist].slice(0,12);
  localStorage.setItem(histKey(cat), JSON.stringify(newHist));

  return picked;
}

// =====================================================
// GENERAZIONE WORKOUT GIORNALIERO
// =====================================================

function generateWorkout(){
  if(data.lastDate !== today()){
    data.lastWorkout = (data.lastWorkout % 3) + 1;
    data.lastDate = today();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }
  document.getElementById("workoutType").innerText = data.lastWorkout;
  renderProgram();
  renderStatus();
}

// =====================================================
// RENDER PROGRAMMA (MOBILITÃ€ PRIMA, RISCALDAMENTO DOPO)
// =====================================================

function exerciseHTML(exObj, catData){
  const link = exObj.link || ("https://www.youtube.com/results?search_query="+encodeURIComponent(exObj.name+" exercise tutorial"));

  let pills = "";
  if(exObj.band){
    const level = (catData && typeof catData.bandLevel==="number") ? catData.bandLevel : 1;
    pills += `<span class="pill">Banda: ${BAND_COLORS[level]}</span>`;
    pills += `<span class="pill"><small>No ancoraggi esterni</small></span>`;
  } else {
    pills += `<span class="pill"><small>Corpo libero</small></span>`;
  }
  if(catData){
    pills += `<span class="pill"><small>Tempo lavoro: ${catData.time} sec</small></span>`;
  }

  return `
  <div class="exercise">
    <b>${exObj.name}</b>
    ${pills}<br><br>
    Ripetizioni/Tempo: <b>${exObj.reps}</b><br>
    <small>Note: ${exObj.note}</small><br><br>
    <a href="${link}" target="_blank" rel="noopener">Apri tutorial</a>
  </div>`;
}

function renderProgram(){
  const mode = document.getElementById("mode").value;

  // Quanti esercizi mostrare per sezione
  const nMob = 2;
  const nWarm = 2;
  const nBlock = 2;
  const nCore = 1;
  const nStretch = 1;

  const container = document.getElementById("program");
  container.innerHTML = "";

  // MOBILITÃ€ (prima)
  container.innerHTML += "<div class='section'><b>MobilitÃ </b></div>";
  pickExercises("mobility", nMob).forEach(ex => {
    container.innerHTML += exerciseHTML(ex);
  });

  // RISCALDAMENTO (dopo)
  container.innerHTML += "<div class='section'><b>Riscaldamento</b></div>";
  pickExercises("warm", nWarm).forEach(ex => {
    container.innerHTML += exerciseHTML(ex);
  });

  // BLOCCHI (pull/push/posterior)
  workouts[data.lastWorkout].forEach(cat=>{
    container.innerHTML += "<div class='section'><b>"+cat.toUpperCase()+"</b></div>";
    pickExercises(cat, nBlock).forEach(ex=>{
      container.innerHTML += exerciseHTML(ex, data.categories[cat]);
    });
  });

  // CORE
  container.innerHTML += "<div class='section'><b>Core</b></div>";
  pickExercises("core", nCore).forEach(ex => {
    container.innerHTML += exerciseHTML(ex, {bandLevel:1, time: (mode==="25"?40:50)});
  });

  // STRETCH
  container.innerHTML += "<div class='section'><b>Stretch</b></div>";
  pickExercises("stretch", nStretch).forEach(ex => {
    container.innerHTML += exerciseHTML(ex);
  });
}

// =====================================================
// TIMER + METRONOMO (fasi invertite)
// =====================================================

let phases = [];
let currentPhaseIndex = 0;
let timer;
let audioCtx;
let gainNode;

function initAudio(){
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  gainNode = audioCtx.createGain();
  gainNode.gain.value = 0.02;
  gainNode.connect(audioCtx.destination);
}
function beep(){
  const osc = audioCtx.createOscillator();
  osc.type = "sine";
  osc.frequency.value = 800;
  osc.connect(gainNode);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.05);
}

function buildPhases(){
  const mode = document.getElementById("mode").value;

  const warmTime = (mode==="25") ? 120 : 180;     // Riscaldamento totale
  const mobilityTime = (mode==="25") ? 120 : 180; // MobilitÃ  totale
  const blockTime = (mode==="25") ? 300 : 420;
  const coreTime = (mode==="25") ? 120 : 180;
  const stretchTime = (mode==="25") ? 120 : 180;

  phases = [];
  currentPhaseIndex = 0;

  // INVERTITO: MobilitÃ  -> Riscaldamento
  phases.push({name:"MobilitÃ ", time: mobilityTime, metronome:false});
  phases.push({name:"Riscaldamento", time: warmTime, metronome:true});

  workouts[data.lastWorkout].forEach(cat=>{
    phases.push({name:"Blocco "+cat, time: blockTime, metronome:true, category:cat});
  });

  phases.push({name:"Core", time: coreTime, metronome:true});
  phases.push({name:"Stretch", time: stretchTime, metronome:false});
}

function startPhase(){
  if(!audioCtx) initAudio();
  buildPhases();
  runPhase();
}

function runPhase(){
  if(currentPhaseIndex >= phases.length){
    clearInterval(timer);
    document.getElementById("phase").innerText = "Sessione completata";
    document.getElementById("timeLeft").innerText = "";
    return;
  }
  const phase = phases[currentPhaseIndex];
  let timeLeft = phase.time;

  document.getElementById("phase").innerText = phase.name;
  document.getElementById("timeLeft").innerText = timeLeft+" sec";

  clearInterval(timer);
  timer = setInterval(()=>{
    timeLeft--;
    document.getElementById("timeLeft").innerText = timeLeft+" sec";

    if(phase.metronome) beep();

    if(timeLeft<=0){
      clearInterval(timer);
      currentPhaseIndex++;
      runPhase();
    }
  },1000);
}

function nextPhase(){
  clearInterval(timer);
  currentPhaseIndex++;
  runPhase();
}

// =====================================================
// PROGRESSIONE (tempo + banda colore; NO kg)
// - Dopo 2 completamenti del blocco categoria:
//   aumenta tempo fino a 50 sec, poi aumenta colore banda (Verde->Giallo->Arancio)
// =====================================================

function completeWorkout(){
  if(data.completedDate !== today()){
    data.streak++;
  }
  data.completedDate = today();

  workouts[data.lastWorkout].forEach(cat=>{
    const c = data.categories[cat];
    c.streak++;

    if(c.streak >= 2){
      if(c.time < 50){
        c.time += 5;
      } else {
        // aumenta banda fino ad Arancio (2)
        c.bandLevel = Math.min(2, c.bandLevel + 1);
        c.time = 40;
      }
      c.streak = 0;
    }
  });

  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  renderStatus();
  alert("Allenamento salvato e progressione aggiornata");
}

function renderStatus(){
  const done = (data.completedDate === today()) ? "âœ” Oggi completato" : "";
  const p = data.categories;
  const status =
    `${done}<br>ðŸ”¥ Giorni consecutivi: ${data.streak}<br><br>`+
    `<small>`+
    `PULL: ${BAND_COLORS[p.pull.bandLevel]} | ${p.pull.time}s<br>`+
    `PUSH: ${BAND_COLORS[p.push.bandLevel]} | ${p.push.time}s<br>`+
    `POSTERIOR: ${BAND_COLORS[p.posterior.bandLevel]} | ${p.posterior.time}s`+
    `</small>`;
  document.getElementById("status").innerHTML = status;
}

// Avvio
generateWorkout();
</script>

</body>
</html>
